<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calendrier SMR Programme</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
}

/* ===================== CALENDRIER ===================== */
.calendar {
  max-width: 1000px;
  margin: 20px auto;
  padding: 10px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.calendar-header button {
  background: #333;
  border: none;
  color: #eee;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}
.calendar-header button:hover {
  background: #444;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  border: 1px solid #333;
}

.day-name {
  background: #1b1b1b;
  padding: 8px;
  text-align: center;
  border-bottom: 1px solid #222;
  font-weight: bold;
}

.day {
  border: 1px solid #222;
  min-height: 100px;
  padding: 4px;
  position: relative;
}

.other-month {
  opacity: 0.35;
}

.event {
  position: absolute;
  left: 2px;
  right: 2px;
  background: #0a84ff;
  border-radius: 4px;
  padding: 2px 5px;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.event.continues-before::before,
.event.continues-after::after {
  content: "";
  position: absolute;
  top: 50%;
  width: 6px;
  height: 6px;
  background: #0a84ff;
  border-radius: 50%;
  transform: translateY(-50%);
}

.event.continues-before::before {
  left: -4px;
}
.event.continues-after::after {
  right: -4px;
}

</style>
</head>
<body>

<div class="calendar">
  <div class="calendar-header">
    <button id="prevMonth">◀</button>
    <h2 id="monthLabel"></h2>
    <button id="nextMonth">▶</button>
  </div>

  <div id="calendarGrid" class="calendar-grid"></div>
</div>

<script>
/* ===============================================================
                       CHARGEMENT ICS
================================================================ */
const ICS_URL = "URL_DU_CALENDRIER_ICS"; // <<< À REMPLACER

async function loadICS() {
  const res = await fetch(ICS_URL);
  const text = await res.text();
  return parseICS(text);
}

function parseICS(text) {
  const events = [];
  const lines = text.split(/\r?\n/);
  let event = null;

  for (const line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) event = {};
    else if (line.startsWith("END:VEVENT")) events.push(event);
    else if (event) {
      if (line.startsWith("DTSTART")) event.start = parseICSTime(line);
      if (line.startsWith("DTEND"))   event.end   = parseICSTime(line);
      if (line.startsWith("SUMMARY")) event.title = line.split(":")[1];
    }
  }
  return events;
}

function parseICSTime(line) {
  const value = line.split(":")[1];
  return new Date(
    value.substring(0,4),
    value.substring(4,6)-1,
    value.substring(6,8)
  );
}

/* ===============================================================
                       CALENDRIER
================================================================ */
let currentDate = new Date();
let events = [];

loadICS().then(ev => {
  events = ev;
  renderCalendar();
});

/* ====== Génération du calendrier ====== */
function renderCalendar() {
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";

  const monthLabel = document.getElementById("monthLabel");
  monthLabel.textContent = currentDate.toLocaleDateString("fr-FR", {
    month: "long",
    year: "numeric"
  });

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);

  const startDay = (firstDay.getDay() + 6) % 7; // Commence lundi
  const totalDays = lastDay.getDate();

  const dayNames = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];
  dayNames.forEach(d => {
    const div = document.createElement("div");
    div.className = "day-name";
    div.textContent = d;
    grid.appendChild(div);
  });

  for (let i = 0; i < startDay; i++) {
    const div = document.createElement("div");
    div.className = "day other-month";
    grid.appendChild(div);
  }

  for (let d = 1; d <= totalDays; d++) {
    const div = document.createElement("div");
    div.className = "day";
    div.dataset.date = new Date(year, month, d).toISOString().split("T")[0];
    div.innerHTML = `<strong>${d}</strong>`;
    grid.appendChild(div);
  }

  placeEvents();
}

/* ===============================================================
              PLACEMENT DES ÉVÈNEMENTS (barres continues)
================================================================ */
function placeEvents() {
  const days = [...document.querySelectorAll(".day")];

  events.forEach(ev => {
    const start = ev.start;
    const end = new Date(ev.end.getTime() - 86400000); // DTEND = exclusive

    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const key = d.toISOString().split("T")[0];
      const cell = days.find(x => x.dataset.date === key);
      if (!cell) continue;

      const bar = document.createElement("div");
      bar.className = "event";
      bar.textContent = ev.title;

      if (d.getTime() > start.getTime()) bar.classList.add("continues-before");
      if (d.getTime() < end.getTime())   bar.classList.add("continues-after");

      cell.appendChild(bar);
    }
  });
}

/* ===============================================================
                       NAVIGATION
================================================================ */
document.getElementById("prevMonth").onclick = () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
};

document.getElementById("nextMonth").onclick = () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
};

</script>
</body>
</html>
