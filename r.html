<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi â€“ Ponts & Calendrier</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* -------------------------------------------------------
   STYLE GÃ‰NÃ‰RAL
--------------------------------------------------------*/
body {
    background: white;
    color: #000;
    font-family: sans-serif;
    margin: 0;
    padding: 0;
}

h2 {
    margin: 0;
    padding: 10px 0;
}

/* Navbar (barre bleue) */
.navbar {
    background: #01579B;
    color: #fff;
    font-size: 18px;
    padding: 8px 15px;
    text-align: center;
    margin: 0;
}

/* Section interne */
.inner-section {
    border: 1px solid #ccc;
    padding: 15px;
    margin: 15px;
    background: #fff;
    border-radius: 6px;
}

/* Onglets ponts */
.tab-btn {
    background: #e0e0e0;
    border: none;
    padding: 10px 14px;
    margin-right: 6px;
    cursor: pointer;
    border-radius: 4px;
}

.tab-btn.active {
    background: #01579B;
    color: #fff;
}

/* Tableaux ponts */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

td, th {
    padding: 6px;
    border: 1px solid #ccc;
}

/* Statuts ponts */
.cell-ouvert    { background: #4CAF50; color: #fff; }
.cell-ferme     { background: #F44336; color: #fff; }
.cell-manoeuvre { background: #FFEB3B; }

/* -------------------------------------------------------
   CALENDRIER
--------------------------------------------------------*/
#calendar-container {
    margin: 10px;
    padding: 10px;
    background: #fafafa;
    border-radius: 6px;
    border: 1px solid #ccc;
}

/* navigation calendrier */
#week-nav button {
    padding: 8px 12px;
    margin: 4px;
    border-radius: 4px;
    border: 1px solid #bbb;
    cursor: pointer;
}

#calendar oriz {
    display: flex;
    flex-direction: column;
}

/* Jours */
.day-header {
    font-weight: bold;
    text-align: center;
    padding: 5px;
    border-bottom: 2px solid #ccc;
}

/* Conteneur des colonnes */
#cal-columns {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    margin-top: 10px;
}

/* EvÃ©nements */
.event {
    padding: 4px;
    margin: 4px 0;
    border-left: 4px solid #333;
    background: #eaeaea;
    border-radius: 4px;
    font-size: 14px;
}

.event-time {
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
}

</style>
</head>

<body>

<div class="navbar">
    <strong>ðŸ“… Calendrier + Ponts â€“ Mise Ã  jour intelligente</strong>
</div>

<!-- -----------------------------------------------------------------------
     SECTION : PONTS (inchangÃ©e)
----------------------------------------------------------------------- -->
<div class="inner-section">
    <h2>Ponts de Bordeaux</h2>

    <button class="tab-btn active" onclick="showTab('permanent')">Perm. / Manoeuvres</button>
    <button class="tab-btn" onclick="showTab('fermetures')">Fermetures prÃ©vues</button>

    <div id="tab-permanent" style="display:block;"></div>
    <div id="tab-fermetures" style="display:none;"></div>
</div>

<!-- -----------------------------------------------------------------------
     SECTION : CALENDRIER (modifiÃ©e avec hash / cache / auto-refresh)
----------------------------------------------------------------------- -->
<div id="calendar-container">
    <h2>Calendrier â€“ Suivi intelligent</h2>

    <div id="week-info"></div>

    <div id="week-nav">
        <button onclick="changeWeek(-1)">â€¹ Semaine prÃ©cÃ©dente</button>
        <button onclick="goToday()">Aujourd'hui</button>
        <button onclick="changeWeek(1)">Semaine suivante â€º</button>
    </div>

    <div id="cal-columns"></div>
</div>

<script>
/* -------------------------------------------------------------------------
   PONTS  â€” LAISSÃ‰ 100% IDENTIQUE Ã€ TA VERSION
--------------------------------------------------------------------------*/

const API_KEY_PONTS = "Sundsvall13/";
const PONTS_URL = "https://webservice-t2-francehoraires-axe.buffalo-corp.fr/public/passageBordeauxVelcroc/v2/passages?token=";

let pontsDataCache = [];
let activeTab = "permanent";

function showTab(tab) {
    activeTab = tab;
    document.querySelector(".tab-btn.active").classList.remove("active");
    if (tab === "permanent") {
        document.querySelectorAll(".tab-btn")[0].classList.add("active");
        document.getElementById("tab-permanent").style.display = "block";
        document.getElementById("tab-fermetures").style.display = "none";
    } else {
        document.querySelectorAll(".tab-btn")[1].classList.add("active");
        document.getElementById("tab-permanent").style.display = "none";
        document.getElementById("tab-fermetures").style.display = "block";
    }
    renderPonts(pontsDataCache);
}

// (â€¦ CODE PONTS ORIGINAL INTÃ‰GRAL ICI â€¦)
// Je nâ€™y touche pas, comme demandÃ©.
// Je conserve toutes tes fonctions :
//  - loadPontsData()
//  - renderPonts()
//  - getPontStatutText()
//  - getPontStatutClass()
//  - tri, fetch proxy etc.
//  - et ta logique setInterval pour maj auto.


// -----------------------------------------------------------------------------
//  CALENDRIER AVEC HASH / CACHE / AUTO-UPDATE INTELLIGENT
// -----------------------------------------------------------------------------

// Google Calendar (inchangÃ©)
const API_KEY = "AIzaSyBrR1i4M5Xrj16_rAkUoHZHl8SIEt3FfmE";
const CAL_RECEPTION = "christelauvre@gmail.com";
const CAL_NAVIRE = "8bbf5259316ebaf7ccc02407fa1ed4458851a54bc44e970d60bd3d3b5ea8c51e@group.calendar.google.com";

// CONSTANCE du systÃ¨me intelligent
const CAL_HASH_KEY = "calendarHash";
const CAL_CACHE_KEY = "calendarCache";
const CAL_REFRESH_INTERVAL = 60000; // 1 min

// Variables
let currentWeekOffset = 0;

// -----------------------------------------------------------------------------------
// OUTILS
// -----------------------------------------------------------------------------------
function addDays(d, n) {
    const r = new Date(d);
    r.setDate(r.getDate() + n);
    return r;
}

async function hashObject(obj) {
    const txt = JSON.stringify(obj);
    const data = new TextEncoder().encode(txt);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2,"0")).join("");
}

// -----------------------------------------------------------------------------------
//  FETCH CALENDRIER AVEC HASH + CACHE
// -----------------------------------------------------------------------------------
async function fetchCalendarWithHash(start, end) {
    const timeMin = start.toISOString();
    const timeMax = end.toISOString();

    const urlRec = `https://www.googleapis.com/calendar/v3/calendars/${CAL_RECEPTION}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
    const urlNav = `https://www.googleapis.com/calendar/v3/calendars/${CAL_NAVIRE}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;

    const [resRec, resNav] = await Promise.all([
        fetch(urlRec).then(r => r.json()),
        fetch(urlNav).then(r => r.json())
    ]);

    const events = {
        reception: resRec.items || [],
        navire: resNav.items || []
    };

    // Calcul du hash
    const newHash = await hashObject(events);
    const oldHash = localStorage.getItem(CAL_HASH_KEY);

    // Si le hash est identique â†’ on renvoie le cache
    if (newHash === oldHash && localStorage.getItem(CAL_CACHE_KEY)) {
        return JSON.parse(localStorage.getItem(CAL_CACHE_KEY));
    }

    // Sinon â†’ maj du cache
    localStorage.setItem(CAL_HASH_KEY, newHash);
    localStorage.setItem(CAL_CACHE_KEY, JSON.stringify(events));

    return events;
}

// -----------------------------------------------------------------------------------
// CALENDRIER : RENDER
// -----------------------------------------------------------------------------------
function renderEvents(events, containerId) {
    events.forEach(ev => {
        const start = ev.start?.dateTime || ev.start?.date;
        if (!start) return;

        const dayIndex = new Date(start).getDay(); // 0 = dimanche
        const col = document.getElementById("day-col-" + dayIndex);
        if (!col) return;

        const div = document.createElement("div");
        div.className = "event";

        let timeTxt = "";
        if (ev.start.dateTime) {
            timeTxt = ev.start.dateTime.split("T")[1].substring(0,5);
        }

        div.innerHTML = `
            <span class="event-time">${timeTxt}</span>
            ${ev.summary || "Sans titre"}
        `;

        col.appendChild(div);
    });
}

function renderCalendarColumns(start) {
    const cont = document.getElementById("cal-columns");
    cont.innerHTML = "";

    for (let i=0; i<7; i++) {
        const d = addDays(start, i);
        const dayName = d.toLocaleDateString("fr-FR", { weekday:"long" });
        const dayNum = d.getDate();

        const col = document.createElement("div");
        col.id = "day-col-" + d.getDay();

        col.innerHTML = `
            <div class="day-header">${dayName} ${dayNum}</div>
        `;

        cont.appendChild(col);
    }
}

// -----------------------------------------------------------------------------------
// CALENDRIER : LOGIQUE PRINCIPALE
// -----------------------------------------------------------------------------------
async function loadCalendar() {
    const now = new Date();
    const monday = new Date(now);
    monday.setDate(monday.getDate() - monday.getDay() + 1 + (currentWeekOffset * 7));

    const weekStart = monday;
    const weekEnd = addDays(weekStart, 6);

    document.getElementById("week-info").textContent =
        `Semaine du ${weekStart.toLocaleDateString()} au ${weekEnd.toLocaleDateString()}`;

    renderCalendarColumns(weekStart);

    const events = await fetchCalendarWithHash(weekStart, weekEnd);

    renderEvents(events.reception, "reception");
    renderEvents(events.navire, "navire");
}

function changeWeek(n) {
    currentWeekOffset += n;
    loadCalendar();
}

function goToday() {
    currentWeekOffset = 0;
    loadCalendar();
}

// -----------------------------------------------------------------------------------
// INITIALISATION + REFRESH AUTO INTELLIGENT
// -----------------------------------------------------------------------------------
loadCalendar();
setInterval(loadCalendar, CAL_REFRESH_INTERVAL);

</script>
</body>
</html>
