<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendrier - Proxy Multi-API</title>
<style>
  :root{
    --bg:#0b1220;
    --card:#0f1724;
    --text:#e6eef8;
    --muted:#98a0b3;
    --accent:#7c3aed;
    --reception:#109c53;
    --navire:#3644b3;
    --cell-w:110px;
    --cell-h:100px;
    --gap:10px;
    --radius:10px;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); padding:18px;}
  .wrap{max-width:1280px;margin:0 auto;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
  .title{font-size:1.25rem;font-weight:700;color:var(--accent);text-align:center;flex:1;}
  .controls{display:flex;gap:8px;align-items:center;}
  .ctrl-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;}
  .ctrl-btn.primary{background:var(--accent);border:0;color:white;}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:var(--gap);justify-items:center;align-items:start;}
  .day{width:var(--cell-w);height:var(--cell-h);background:var(--card);border-radius:var(--radius);padding:8px;position:relative;overflow:visible;display:flex;flex-direction:column;gap:6px;opacity:0; transform:translateY(6px) scale(.99); transition:transform .18s ease, box-shadow .18s ease, opacity .2s ease;}
  .day.show{opacity:1; transform:translateY(0) scale(1);}
  .day.past{transform:scale(.92);opacity:.85;}
  .day.today{transform:scale(1.06);box-shadow:0 0 28px rgba(124,58,237,0.28);z-index:6;}
  .day.future{box-shadow:0 0 18px rgba(124,58,237,0.12);}
  .day:hover{transform:scale(1.04);z-index:8;}
  .day.today:hover{transform:scale(1.15);}
  .day.future:hover{transform:scale(1.12);box-shadow:0 0 22px rgba(124,58,237,0.8);}
  .date-num{font-weight:700;font-size:.95rem;}
  .weekday{font-size:.75rem;color:var(--muted);}
  .events{display:flex;flex-direction:column;gap:6px;flex:1;overflow:visible;}
  .ev{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;color:white;font-size:.78rem;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:100%;box-shadow:0 6px 16px rgba(2,6,23,0.45);cursor:pointer;}
  .ev.reception{background:var(--reception);}
  .ev.navire{background:var(--navire);}
  .span-bar{position:absolute;left:6px;right:6px;top:45px;height:28px;border-radius:8px;color:white;display:flex;align-items:center;padding:6px 10px;font-weight:700;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .day::after{content:'';position:absolute;inset:0;border-radius:inherit;box-shadow:0 0 0 0 rgba(124,58,237,0.12);animation:pulse 3s infinite;pointer-events:none;}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(124,58,237,0.06);}70%{box-shadow:0 0 0 8px rgba(124,58,237,0.00);}100%{box-shadow:0 0 0 0 rgba(124,58,237,0.00);}}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:60;}
  .modal{min-width:280px;border-radius:12px;padding:18px;color:white;box-shadow:0 12px 40px rgba(2,6,23,0.6);transform:scale(.98);opacity:0;transition:all .18s ease;}
  .modal.show{transform:scale(1);opacity:1;}
  .modal h3{margin:0 0 8px;}
  .modal .dates{font-weight:600;font-size:.95rem;}
  .close-hint{font-size:.85rem;color:rgba(255,255,255,0.9);margin-top:10px;}
  @media(max-width:900px){:root{--cell-w:calc((100vw - 40px) / 4);--cell-h:90px}.calendar{grid-template-columns:repeat(4,1fr);}}
  @media(max-width:600px){:root{--cell-w:calc((100vw - 36px) / 2);--cell-h:92px}.calendar{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div class="title" id="titleMonths">...</div>
    <div class="controls">
      <button class="ctrl-btn" id="prevWeek">&lt;</button>
      <button class="ctrl-btn primary" id="todayBtn">Aujourd'hui</button>
      <button class="ctrl-btn" id="nextWeek">&gt;</button>
    </div>
  </header>
  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
    <div class="meta" id="rangeLabel">Chargement…</div>
    <div class="meta" id="statusInfo"></div>
  </div>
  <main>
    <div class="calendar" id="calendarGrid" aria-live="polite"></div>
  </main>
</div>

<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Titre</h3>
    <div class="dates" id="modalDates">Dates</div>
    <div class="close-hint">Cliquez en dehors pour fermer</div>
  </div>
</div>

<script>
const CONFIG = {
  calendars: [
    { id:"receptionroulier@gmail.com", name:"Réception", class:"reception", color:"#109c53" },
    { id:"smr.programme@gmail.com", name:"Navire", class:"navire", color:"#3644b3" }
  ],
  cacheKey:"caltest_cache_proxy",
  hashKey:"caltest_hash_proxy",
  cacheTtl:120000,
  weeksToShow:4,
  accent:"#7c3aed"
};

let viewStartDate = new Date();
viewStartDate.setDate(viewStartDate.getDate() - 7); // start previous week
const grid = document.getElementById('calendarGrid');
const titleMonthsEl = document.getElementById('titleMonths');
const rangeLabel = document.getElementById('rangeLabel');
const statusInfo = document.getElementById('statusInfo');
const prevBtn = document.getElementById('prevWeek');
const nextBtn = document.getElementById('nextWeek');
const todayBtn = document.getElementById('todayBtn');
const modalBackdrop = document.getElementById('modalBackdrop');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalDates = document.getElementById('modalDates');

prevBtn.onclick = ()=>{ shiftWeeks(-1); };
nextBtn.onclick = ()=>{ shiftWeeks(1); };
todayBtn.onclick = ()=>{ goToday(); };
modalBackdrop.onclick = (e)=>{ if(e.target===modalBackdrop) closeModal(); };

function shiftWeeks(n){ viewStartDate.setDate(viewStartDate.getDate()+n*7); render(); }
function goToday(){ viewStartDate = new Date(); viewStartDate.setDate(viewStartDate.getDate()-7); render(); }
function closeModal(){ modal.classList.remove('show'); setTimeout(()=>modalBackdrop.style.display='none',200); }
function openModal(ev,color){ modalTitle.textContent=ev.summary||'(sans titre)'; const sd=new Date(ev.start.dateTime||ev.start.date); const ed=new Date(ev.end.dateTime||ev.end.date); modalDates.textContent=`Du ${sd.toLocaleString()} Au ${ed.toLocaleString()}`; modal.style.background=color; modalBackdrop.style.display='flex'; setTimeout(()=>modal.classList.add('show'),10); }

function isoDateNoTime(d){ return new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString().slice(0,10);}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x;}

async function fetchCalendarProxy(calID){ const r = await fetch(`/api/calendar?calendar=${calID}`); return r.json(); }

async function fetchAllEvents(){
  const cached = JSON.parse(localStorage.getItem(CONFIG.cacheKey)||"null");
  if(cached && Date.now()-cached.timestamp<CONFIG.cacheTtl) return cached.data;
  const rec = await fetchCalendarProxy(CONFIG.calendars[0].id);
  const nav = await fetchCalendarProxy(CONFIG.calendars[1].id);
  const data = { rec, nav };
  const hash = JSON.stringify(data).length;
  if(cached && cached.hash===hash) return cached.data;
  localStorage.setItem(CONFIG.cacheKey, JSON.stringify({timestamp:Date.now(), hash, data}));
  return data;
}

async function render(){
  const events = await fetchAllEvents();
  grid.innerHTML="";
  const start = new Date(viewStartDate);
  const days=[];
  for(let i=0;i<CONFIG.weeksToShow*7;i++) days.push(addDays(start,i));
  const months = Array.from(new Set(days.map(d=>d.toLocaleString('fr-FR',{month:'long',year:'numeric'}))));
  titleMonthsEl.textContent = months.join(' / ');
  const today = isoDateNoTime(new Date());
  days.forEach((d,i)=>{
    const iso = isoDateNoTime(d);
    const cell=document.createElement('div');
    cell.className='day'+(iso<today?' past':iso===today?' today':' future');
    setTimeout(()=>cell.classList.add('show'),i*40);
    const wd = d.toLocaleString('fr-FR',{weekday:'short'});
    const num = d.getDate();
    cell.innerHTML=`<div><div class="weekday">${wd}</div><div class="date-num">${num}</div></div><div class="events"></div>`;
    const eventsContainer=cell.querySelector('.events');
    [...(events.rec.items||[]).map(e=>({...e,type:'rec'})), ...(events.nav.items||[]).map(e=>({...e,type:'nav'}))].forEach(ev=>{
      const s=new Date(ev.start.date||ev.start.dateTime);
      const e=new Date(ev.end.date||ev.end.dateTime);
      if(d>=s && d<e){
        const chip=document.createElement('button');
        chip.className='ev '+(ev.type==='rec'?'reception':'navire');
        chip.style.background=CONFIG.calendars.find(c=>c.id===ev._calendarId)?.color||'';
        chip.textContent=ev.summary||'(sans titre)';
        chip.addEventListener('click',()=>openModal(ev,chip.style.background));
        eventsContainer.appendChild(chip);
      }
    });
    grid.appendChild(cell);
  });
}

render();
setInterval(()=>render(),CONFIG.cacheTtl);
</script>
</body>
</html>
