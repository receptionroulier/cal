<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calendrier 3 semaines - sombre + cache</title>
<style>
:root{
  --bg:#121212;
  --card:#1c1f23;
  --border:#555;
  --text:#eaeaea;
  --muted:#999;
  --accent:#00e5ff;
  --gap:4px;
  --days-font:14px;
  --event-font:14px;
}
body{
  margin:0;
  font-family:Inter, system-ui, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
  box-sizing:border-box;
}
.container{
  max-width:1600px;
  margin:0 auto;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  gap:20px;
  flex-wrap:wrap;
}
header h1{
  margin:0;
  font-size:24px;
  color:var(--accent);
  text-align:center;
}
.nav-buttons{
  display:flex;
  gap:8px;
  align-items:center;
}
.nav-buttons button{
  background:none;
  border:none;
  color:var(--accent);
  font-size:16px;
  cursor:pointer;
  padding:4px 8px;
  transition: all 0.35s ease;
}
.nav-buttons button:hover { background: rgba(0,229,255,0.2); }

.calendar {
  background: var(--card);
  border-radius:12px;
  padding:12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  width: 100%;
}
.grid {
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap: var(--gap);
}
.day {
  background: #141619;
  border-radius:12px;
  height: calc((100vh - 150px)/4);
  padding:12px;
  box-sizing:border-box;
  border:1px solid var(--border);
  overflow:hidden;
  position:relative;
  display:flex;
  flex-direction:column;
  transition: transform 0.35s ease, width 0.35s ease, background 0.25s, box-shadow 0.35s, border-color 0.25s;
}

@keyframes todayPulse {
  0%,100%{ transform: scale(1.08); }
  50%{ transform: scale(1.12); }
}
.day.today {
  transform: scale(1.08);
  animation: todayPulse 3s infinite ease-in-out;
  background:#1f2226;
  border:2px solid var(--accent);
  z-index:2;
}
.day.today::after {
  content:"";
  position:absolute;
  inset:0;
  border-radius:12px;
  pointer-events:none;
  box-shadow:0 0 20px 8px rgba(0,229,255,0.5);
}

@keyframes futurePulse {
  0%,100%{ transform: scale(1); }
  50%{ transform: scale(1.02); }
}
.day.future {
  transform: scale(1);
  background:#1c1f23;
  color:#eaeaea;
  animation: futurePulse 3s infinite ease-in-out;
}

.day.past {
  transform: scale(0.95);
  background:#0f1113;
  color:#555;
}

.day.today:hover,
.day.future:hover {
  animation:none;
  transform: scale(1.12);
  z-index:10;
  width: 140%;
}

.day .event .title {
  white-space: nowrap;
  overflow: hidden;
  text-overflow:ellipsis;
}

.day-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:var(--days-font);
  margin-bottom:2px;
}
.day .date { font-weight:600; font-size:var(--days-font); }
.events {
  flex:1 1 auto;
  display:flex;
  flex-direction:column;
  gap:2px;
  overflow:hidden;
}
.event {
  display:flex;
  align-items:center;
  gap:4px;
  padding:2px 4px;
  font-size:var(--event-font);
  border-radius:6px;
  background: rgba(0,0,0,0.3);
  cursor:pointer;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  transition: background 0.25s ease;
}
.event:hover { background: rgba(0,0,0,0.5); }
.event .time { min-width:50px; font-weight:600; font-size:11px; }
.event.allDay .time { display:none; }
.event.more { font-size:12px; color:var(--muted); padding-left:6px; }
.event .title { text-align:left; }
.c-reception { color:#109c53; }
.c-smr { color:#5768cb; }

#popup {
  position: fixed;
  top:50%;
  left:50%;
  transform: translate(-50%,-50%);
  background:#1c1f23;
  color:#fff;
  padding:16px;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,0,0,0.8);
  z-index:20;
  max-width:90%;
  min-width:300px;
  display:none;
}
#popup h3 { margin-top:0; margin-bottom:8px; }
#popup .close { position:absolute; top:8px; right:12px; cursor:pointer; font-weight:bold; font-size:18px; }

@media(max-width:900px){ .grid{ grid-template-columns: repeat(2,1fr); } }
@media(max-width:520px){ .grid{ grid-template-columns: repeat(1,1fr); } }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1 id="month-title">Mois</h1>
    <div class="nav-buttons">
      <button id="prev-week">&lt;</button>
      <button id="today-btn">Aujourd'hui</button>
      <button id="next-week">&gt;</button>
    </div>
  </header>
  <div class="calendar" id="calendar-root">
    <div class="grid" id="grid"></div>
  </div>
</div>

<div id="popup">
  <span class="close" onclick="document.getElementById('popup').style.display='none'">&times;</span>
  <h3 id="popup-title"></h3>
  <div id="popup-time"></div>
</div>

<script>
/* ==========================
   CONFIG GOOGLE + CALENDARS
========================== */
const API_KEY = 'AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo';
const CALENDARS = [
  { id:'receptionroulier@gmail.com', key:'reception', css:'c-reception'},
  { id:'smr.programme@gmail.com', key:'smr', css:'c-smr'}
];
const WEEKS = 3;

/* ==========================
       CONFIG CACHE 120s
========================== */
const CACHE_TTL = 120 * 1000;
const CACHE_KEY = "googleCalendarCache_v1";

function loadCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (!data.timestamp || (Date.now() - data.timestamp) > CACHE_TTL) return null;
    return data.payload;
  } catch {
    return null;
  }
}

function saveCache(payload) {
  localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), payload }));
}

function hashEvents(items) {
  let h = 0;
  const str = items.map(ev =>
    (ev.iCalUID || "") +
    (ev.summary || "") +
    (ev.start?.dateTime || ev.start?.date || "") +
    (ev.end?.dateTime || ev.end?.
