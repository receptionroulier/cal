<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendrier Google</title>
<style>
    /* ========== RESET & BASE ========== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #121212; color: #fff; overflow-x: hidden; }
    h1 { text-align: center; margin: 20px 0; }

    /* ========== CALENDRIER ========== */
    .calendar-container { width: 95%; max-width: 1200px; margin: auto; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .calendar-title { font-size: 1.5rem; color: #f39c12; text-align: center; flex: 1; }
    .calendar-nav button { background: #333; color: #fff; border: none; padding: 5px 15px; margin: 0 5px; cursor: pointer; border-radius: 5px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .day-cell {
        background: #1e1e1e;
        min-height: 100px;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding: 5px;
        transition: all 0.2s ease;
        animation: fadeIn 0.3s ease forwards;
    }
    .day-cell.past { font-size: 0.8rem; opacity: 0.6; }
    .day-cell.today { transform: scale(1.1); box-shadow: 0 0 15px #f39c12; }
    .day-cell.future { border: 2px solid #555; }

    .day-cell:hover.today { transform: scale(1.2); box-shadow: 0 0 25px #f39c12; }
    .day-cell:hover.future { transform: scale(1.1); box-shadow: 0 0 15px #888; }

    .event { margin-top: 3px; padding: 2px 5px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .event.reception { background-color: #109c53; color: #fff; }
    .event.navire { background-color: #3644b3; color: #fff; }

    @keyframes fadeIn { from {opacity:0} to {opacity:1} }

    /* ========== POPUP ========== */
    .popup-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:1000; }
    .popup { background:#222; padding:20px; border-radius:10px; min-width:300px; max-width:90%; animation: pulse 0.3s ease; }
    .popup h2 { margin-bottom:10px; }
    .popup p { font-size:0.9rem; }
    @keyframes pulse { 0% {transform:scale(0.95)} 50% {transform:scale(1.05)} 100% {transform:scale(1)} }
</style>
</head>
<body>
<div class="calendar-container">
    <div class="calendar-header">
        <div class="calendar-nav">
            <button id="prevWeek">&lt;</button>
        </div>
        <div class="calendar-title" id="calendarTitle"></div>
        <div class="calendar-nav">
            <button id="todayWeek">Aujourd'hui</button>
            <button id="nextWeek">&gt;</button>
        </div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div id="popupContainer" style="display:none;"></div>

<script>
const CACHE_KEY_DATA = "calendriersData";
const CACHE_KEY_HASH = "calendriersHash";
const CACHE_KEY_TIME = "contsCacheTime";
const CACHE_EXPIRATION = 120000; // 2 min
const REFRESH_INTERVAL = 60000; // 1 min

const PROXIES = [
    "https://api.allorigins.win/get?url=",
    "https://cors-anywhere.herokuapp.com/",
    "https://thingproxy.freeboard.io/fetch/"
];

const CAL_IDS = [
    { id: "receptionroulier@gmail.com", color: "#109c53", type: "reception" },
    { id: "smr.programme@gmail.com", color: "#3644b3", type: "navire" }
];

const API_KEY = "AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo";

let currentDate = new Date();

async function sha256(str) {
    const data = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(digest))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

async function fetchWithRandomProxy(url) {
    const shuffledProxies = [...PROXIES].sort(() => Math.random() - 0.5);
    for (const proxy of shuffledProxies) {
        try {
            const fullUrl = proxy + encodeURIComponent(url);
            const res = await fetch(fullUrl);
            if (!res.ok) throw new Error(`Proxy failed: ${res.status}`);
            const data = await res.json();
            return data.contents ? JSON.parse(data.contents) : data;
        } catch (err) {
            console.warn(`Échec du proxy ${proxy}:`, err.message);
        }
    }
    throw new Error("Tous les proxys ont échoué");
}

async function fetchEvents() {
    const now = new Date();
    const timeMin = new Date(now.getFullYear(), now.getMonth(), now.getDate()-7).toISOString();
    const timeMax = new Date(now.getFullYear(), now.getMonth(), now.getDate()+21).toISOString();

    let allEvents = [];
    for (const cal of CAL_IDS) {
        const url = `https://www.googleapis.com/calendar/v3/calendars/${cal.id}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
        try {
            const data = await fetchWithRandomProxy(url);
            const events = data.items.map(ev => ({ ...ev, type: cal.type, color: cal.color }));
            allEvents = allEvents.concat(events);
        } catch(e) { console.error("Erreur fetch calendrier:", e); }
    }
    return allEvents;
}

async function getCachedEvents() {
    const lastHash = localStorage.getItem(CACHE_KEY_HASH);
    const lastTime = localStorage.getItem(CACHE_KEY_TIME);
    const lastData = localStorage.getItem(CACHE_KEY_DATA);

    if (lastData && lastTime && (Date.now() - lastTime < CACHE_EXPIRATION)) {
        const hash = await sha256(lastData);
        if (hash === lastHash) return JSON.parse(lastData);
    }

    const events = await fetchEvents();
    const eventsStr = JSON.stringify(events);
    const newHash = await sha256(eventsStr);
    localStorage.setItem(CACHE_KEY_DATA, eventsStr);
    localStorage.setItem(CACHE_KEY_HASH, newHash);
    localStorage.setItem(CACHE_KEY_TIME, Date.now());
    return events;
}

function renderCalendar(events) {
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";
    const start = new Date(currentDate);
    start.setDate(start.getDate() - start.getDay() - 7); // semaine passée
    const cells = [];

    for (let i=0;i<28;i++) {
        const day = new Date(start);
        day.setDate(day.getDate()+i);
        const cell = document.createElement("div");
        cell.className = "day-cell";

        if (day < new Date()) cell.classList.add("past");
        else if (day.toDateString() === new Date().toDateString()) cell.classList.add("today");
        else cell.classList.add("future");

        const dayNum = document.createElement("div");
        dayNum.textContent = day.getDate();
        cell.appendChild(dayNum);

        const dayEvents = events.filter(ev => {
            const evDate = new Date(ev.start.dateTime || ev.start.date);
            return evDate.toDateString() === day.toDateString();
        });

        dayEvents.forEach(ev => {
            const evDiv = document.createElement("div");
            evDiv.className = `event ${ev.type}`;
            evDiv.textContent = ev.summary;
            evDiv.style.backgroundColor = ev.color;
            evDiv.addEventListener("click", e => showPopup(ev));
            cell.appendChild(evDiv);
        });

        grid.appendChild(cell);
    }

    const monthNames = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
    const firstMonth = start.getMonth();
    const lastMonth = new Date(start);
    lastMonth.setDate(lastMonth.getDate()+27);
    const title = monthNames[firstMonth] === monthNames[lastMonth.getMonth()] ? monthNames[firstMonth] : `${monthNames[firstMonth]} - ${monthNames[lastMonth.getMonth()]}`;
    document.getElementById("calendarTitle").textContent = title;
}

function showPopup(ev) {
    const overlay = document.createElement("div");
    overlay.className = "popup-overlay";
    overlay.addEventListener("click", () => overlay.remove());

    const popup = document.createElement("div");
    popup.className = "popup";
    popup.style.backgroundColor = ev.color;
    popup.innerHTML = `
        <h2>${ev.summary}</h2>
        <p>Du ${new Date(ev.start.dateTime || ev.start.date).toLocaleString()}<br>Au ${new Date(ev.end.dateTime || ev.end.date).toLocaleString()}</p>
    `;
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
}

// Navigation
document.getElementById("prevWeek").addEventListener("click",()=>{currentDate.setDate(currentDate.getDate()-7); getCachedEvents().then(renderCalendar);});
document.getElementById("nextWeek").addEventListener("click",()=>{currentDate.setDate(currentDate.getDate()+7); getCachedEvents().then(renderCalendar);});
document.getElementById("todayWeek").addEventListener("click",()=>{currentDate=new Date(); getCachedEvents().then(renderCalendar);});

// Initial
getCachedEvents().then(renderCalendar);
setInterval(()=>getCachedEvents().then(renderCalendar), REFRESH_INTERVAL);

</script>
</body>
</html>
