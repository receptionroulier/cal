<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />

<style>
/* === MODE SOMBRE, PALLETTE, BASE === */
:root {
  --bg: #1e1e1e;
  --card: #2b2b2b;
  --accent: #4caf50;
  --accent-light: #81c784;
  --text: #e0e0e0;
}

body {
  margin: 0; padding: 0;
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  font-family: Arial, sans-serif;
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
}

/* === TITRE MOIS === */
.calendar-header { width: 95%; max-width: 1100px; text-align: center; margin: 20px 0 10px; }
.calendar-header h1 { font-size: 2.2em; margin:0; font-weight:600; color: var(--accent-light); }

/* === CONTROLES === */
.calendar-controls {
  width: 95%; max-width: 1100px;
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
}
.calendar-controls button {
  background: var(--card); color: var(--text);
  border: none; padding: 10px 15px; border-radius: 5px;
  cursor: pointer; transition: background 0.2s;
}
.calendar-controls button:hover { background: #3b3b3b; }

.calendar-controls select {
  background: var(--card); color: var(--text);
  border: none; padding: 10px;
  border-radius: 5px; cursor: pointer;
}

/* === GRID === */
.calendar-grid {
  width: 95%; max-width: 1100px;
  display: grid; grid-template-columns: repeat(7,1fr);
  gap: 10px;
}

/* === JOURS === */
.day {
  background: var(--card);
  border-radius: 10px;
  padding: 10px;
  min-height: 130px;
  display: flex; flex-direction: column;
  transition: transform 0.1s, box-shadow 0.1s;
}
.day:hover {
  transform: scale(1.02);
  box-shadow: 0 0 10px rgba(255,255,255,0.15);
  z-index: 10;
}

.day-header { display: flex; justify-content: space-between; margin-bottom:5px; }
.date { font-size:1.1em; font-weight:bold; }

/* === COULEURS (passé / futur / aujourd’hui) === */
.day.past   { background: #252525; }
.day.future { background: #2d2d2d; }
.day.today  {
  background: var(--accent); color:#000;
  box-shadow: 0 0 10px var(--accent-light);
  animation: todayPulse 2s infinite;
}
@keyframes todayPulse { 0%{box-shadow:0 0 5px var(--accent-light);} 50%{box-shadow:0 0 20px var(--accent-light);} }

/* === ÉVÉNEMENTS === */
.events { flex:1; overflow:hidden; display:flex; flex-direction:column; gap:4px; }

.event {
  display:flex; flex-direction:row; align-items:center;
  background: #3a3a3a;
  padding: 4px 6px; border-radius:4px;
  font-size:0.85em; cursor:pointer;
  transition: background 0.15s;
}
.event:hover { background:#505050; }
.event .time  { font-weight:bold; margin-right:6px; }
.event .title { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.event.allDay { background:#5a5a5a; }

.event.more {
  background: #444; text-align:center; color:#ccc;
  cursor:initial; padding:4px 6px;
}

/* COULEURS PAR CALENDRIER */
.color-cal1 { background:#3d85c6 !important; }
.color-cal2 { background:#6aa84f !important; }
.color-cal3 { background:#a64d79 !important; }
.color-cal4 { background:#cc0000 !important; }

/* === POPUP === */
.popup {
  display:none; position:fixed; left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); justify-content:center; align-items:center;
  z-index:20;
}
.popup-content {
  background:#2e2e2e; padding:20px; border-radius:10px; width:300px;
  text-align:center; color:#fff;
}

/* === RESPONSIVE === */
@media (max-width:800px){
  .calendar-grid { grid-template-columns:repeat(4,1fr); }
}
@media (max-width:500px){
  .calendar-grid { grid-template-columns:repeat(2,1fr); }
  .calendar-controls { flex-direction:column; gap:10px; }
}
</style>
</head>

<body>

<!-- TITRE -->
<div class="calendar-header">
  <h1 id="monthTitle">Calendrier</h1>
</div>

<!-- CONTROLES -->
<div class="calendar-controls">
  <div>
    <button id="prevWeekBtn">← Semaine précédente</button>
    <button id="todayBtn">Aujourd’hui</button>
    <button id="nextWeekBtn">Semaine suivante →</button>
  </div>
  <div>
    <label for="weekCount">Afficher :</label>
    <select id="weekCount">
      <option value="3">3 semaines</option>
      <option value="4">4 semaines</option>
    </select>
  </div>
</div>

<!-- GRID -->
<div class="calendar-grid" id="calendarGrid"></div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content">
    <h2 id="popupTitle"></h2>
    <p id="popupTime"></p>
    <button onclick="popup.style.display='none'">Fermer</button>
  </div>
</div>

<script>
/* ========================================================
      CONFIG CALENDRIERS
======================================================== */
const CALENDARS = [
  { name:"Famille",   key:"fam",   id:"xxxxx1", css:"color-cal1" },
  { name:"Travail",   key:"work",  id:"xxxxx2", css:"color-cal2" },
  { name:"Perso",     key:"perso", id:"xxxxx3", css:"color-cal3" },
  { name:"Sport",     key:"sport", id:"xxxxx4", css:"color-cal4" }
];

const API_KEY = "TA_CLE_API";

/* ========================================================
      MULTI-PROXIES + FALLBACK AUTOMATIQUE
======================================================== */
const PROXIES = [
  "https://proxy1.example.com/",
  "https://proxy2.example.com/",
  "https://proxy3.example.com/"
];

async function fetchWithProxies(url) {
  let lastError = null;

  for (const proxy of PROXIES) {
    const proxiedUrl = proxy + encodeURIComponent(url);

    try {
      const response = await fetch(proxiedUrl);

      if (response.ok) {
        return await response.json();
      } else {
        lastError = new Error("Proxy " + proxy + " renvoie status " + response.status);
      }
    } catch(e) {
      lastError = e;
    }
  }

  throw lastError || new Error("Aucun proxy n'a fonctionné");
}

/* ========================================================
      CACHE LOCAL
======================================================== */
function makeHash(str){
  let h=0, i=0, len=str.length;
  while(i<len){ h=(h<<5)-h+str.charCodeAt(i++)|0; }
  return h;
}

function cacheGet(key) {
  try { return JSON.parse(localStorage.getItem(key)); }
  catch(e){ return null; }
}

function cacheSet(key,val) {
  localStorage.setItem(key, JSON.stringify(val));
}

/* ========================================================
      FETCH ÉVÉNEMENTS GOOGLE CALENDAR (avec cache + proxies)
======================================================== */
async function getEventsForCalendar(calId, timeMin, timeMax){
  const url =
    `https://www.googleapis.com/calendar/v3/calendars/${calId}/events?` +
    `key=${API_KEY}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&singleEvents=true&orderBy=startTime`;

  return await fetchWithProxies(url);
}

async function getEvents(timeMin, timeMax){
  const cacheKey = `calCache_${timeMin}_${timeMax}`;
  const cached = cacheGet(cacheKey);
  const ttl = 180000; // 3min

  if(cached && Date.now() - cached.timestamp < ttl) {
    return cached.payload;
  }

  const results = {};
  const allRaw = [];

  for(const c of CALENDARS){
    const raw = await getEventsForCalendar(c.id, timeMin, timeMax);
    results[c.key] = raw.items || [];
    allRaw.push(JSON.stringify(raw.items || []));
  }

  const combinedString = allRaw.join("|");
  const hash = makeHash(combinedString);

  cacheSet(cacheKey, { timestamp:Date.now(), payload:results, hash });

  return results;
}

/* ========================================================
      OUTILS DATES
======================================================== */
function fmtDate(d){
  return d.toISOString().slice(0,10);
}
function fmtTime(iso){
  const d=new Date(iso), h=("0"+d.getHours()).slice(-2), m=("0"+d.getMinutes()).slice(-2);
  return `${h}h${m}`;
}
function shortTitle(str,maxLen){ return (str.length > maxLen ? str.slice(0,maxLen)+"…" : str); }

/* ========================================================
      VARIABLES & ÉLÉMENTS
======================================================== */
let WEEKS = 3;
const today = new Date();
today.setHours(0,0,0,0);

// Lundi de la semaine courante
let weekStart = new Date(today);
weekStart.setDate(today.getDate() - ((today.getDay()+6)%7));

let gridStartDate = new Date(weekStart);

const gridEl = document.getElementById("calendarGrid");
const monthTitle = document.getElementById("monthTitle");
const weekCountSelect = document.getElementById("weekCount");
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupTime = document.getElementById("popupTime");

/* ========================================================
      RENDU PRINCIPAL DU CALENDRIER
======================================================== */
async function renderCalendar(){
  const dates=[];
  for(let w=0; w<WEEKS; w++){
    for(let i=0; i<7; i++){
      const d=new Date(gridStartDate);
      d.setDate(d.getDate() + w*7 + i);
      dates.push(d);
    }
  }

  gridEl.style.gridTemplateRows = `repeat(${WEEKS},1fr)`;
  gridEl.innerHTML = "";

  // GÉNÉRATION DES CASES
  dates.forEach(d=>{
    const dayEl=document.createElement("div");
    dayEl.className="day";
    dayEl.dataset.date=fmtDate(d);
    dayEl.innerHTML=`
      <div class="day-header">
        <div>${["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()]}</div>
        <div class="date">${d.getDate()}</div>
      </div>
      <div class="events"></div>
    `;
    gridEl.appendChild(dayEl);
  });

  const timeMin = new Date(dates[0]);
  timeMin.setHours(0,0,0,0);
  const timeMax = new Date(dates[dates.length-1]);
  timeMax.setHours(23,59,59,999);

  const eventsByDay = {};
  const fetched = await getEvents(timeMin.toISOString(), timeMax.toISOString());
  const seen = new Set();

  for(const key in fetched){
    for(const it of fetched[key]){
      const dedupe = it.iCalUID || it.id || it.summary;
      if(seen.has(dedupe)) continue;
      seen.add(dedupe);

      const start = it.start?.dateTime || it.start?.date;
      const end = it.end?.dateTime || it.end?.date;
      const allDay = !!it.start?.date;
      const cal = CALENDORS.find(c=>c.key===key) || {key};

      if(allDay) {
        let s=new Date(start+"T00:00:00");
        let e=new Date(end+"T00:00:00");
        for(let d=new Date(s); d<e; d.setDate(d.getDate()+1)){
          const k=fmtDate(d);
          eventsByDay[k] = eventsByDay[k] || [];
          eventsByDay[k].push({ title:it.summary||"(sans titre)", start:null,end:null,allDay:true, calendarKey:cal.key });
        }
      } else {
        const k=fmtDate(new Date(start));
        eventsByDay[k] = eventsByDay[k] || [];
        eventsByDay[k].push({ title:it.summary||"(sans titre)", start, end, allDay:false, calendarKey:cal.key });
      }
    }
  }

  // RENDU ÉVÉNEMENTS
  document.querySelectorAll(".day").forEach(dayEl=>{
    const date = dayEl.dataset.date;
    const list = eventsByDay[date] || [];
    const container = dayEl.querySelector(".events");
    container.innerHTML = "";

    list.slice(0,6).forEach(ev=>{
      const calMeta = CALENDORS.find(c=>c.key===ev.calendarKey);
      const evEl = document.createElement("div");
      evEl.className = `event ${ev.allDay?"allDay":""} ${calMeta?calMeta.css:""}`;

      evEl.innerHTML = `
        <div class="time">${ev.allDay?"":fmtTime(ev.start)}</div>
        <div class="title">${shortTitle(ev.title,80)}</div>
      `;

      evEl.onclick = ()=>{
        popupTitle.textContent = ev.title;
        popupTime.textContent = ev.allDay ? "Toute la journée"
            : `${fmtTime(ev.start)} → ${fmtTime(ev.end)}`;
        popup.style.display="block";
      };

      container.appendChild(evEl);
    });

    if(list.length>6){
      const more=document.createElement("div");
      more.className="event more";
      more.textContent = `+ ${list.length-6} autres`;
      container.appendChild(more);
    }
  });

  // STYLE JOUR
  const todayStr = fmtDate(new Date());
  document.querySelectorAll(".day").forEach(dayEl=>{
    const d=dayEl.dataset.date;
    dayEl.classList.remove("past","future","today");

    if(d===todayStr) dayEl.classList.add("today");
    else if(d<todayStr) dayEl.classList.add("past");
    else dayEl.classList.add("future");
  });

  // TITRE DU MOIS
  const monthNames=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  monthTitle.textContent = monthNames[dates[0].getMonth()]+" "+dates[0].getFullYear();
}

/* ========================================================
      CONTROLES
======================================================== */
document.getElementById("prevWeekBtn").onclick = ()=>{
  gridStartDate.setDate(gridStartDate.getDate()-7);
  renderCalendar();
};
document.getElementById("nextWeekBtn").onclick = ()=>{
  gridStartDate.setDate(gridStartDate.getDate()+7);
  renderCalendar();
};
document.getElementById("todayBtn").onclick = ()=>{
  const today=new Date();
  today.setHours(0,0,0,0);
  const wstart=new Date(today);
  wstart.setDate(today.getDate()-((today.getDay()+6)%7));
  gridStartDate = wstart;
  renderCalendar();
};
weekCountSelect.onchange = ()=>{
  WEEKS = parseInt(weekCountSelect.value);
  renderCalendar();
};

/* ========================================================
      AUTO-REFRESH
======================================================== */
setInterval(renderCalendar, 60000);

/* ========================================================
      LANCEMENT INITIAL
======================================================== */
renderCalendar();
</script>

</body>
</html>
