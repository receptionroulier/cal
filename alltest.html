<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ponts HAROPA – Monitoring + Calendrier</title>
<style>
/* ===================== GLOBAL ===================== */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #101010;
  color: #eaeaea;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ===================== COLONNE GAUCHE ===================== */
.left {
  flex: 0 0 20%;
  border-right: 1px solid #444;
  padding: 14px;
  overflow-y: auto;
  box-sizing: border-box;
}
.left h2 { color: #00e5ff; text-align: center; }

/* ===================== CARTES PONTS ===================== */
.pont-card {
  background: #1f1f1f;
  border-radius: 8px;
  padding: 10px 12px;
  box-shadow: 0 0 5px rgba(0,0,0,0.4);
  border-left: 4px solid #444;
  transition: transform 0.15s ease, box-shadow 0.3s ease;
  margin-bottom: 8px;
}
.pont-card:hover { transform: scale(1.02); }
.pont-card.ferme { border-left-color: #ff4040; }
.pont-card.fermeture { border-left-color: orange; animation: pulse-orange 1.2s infinite; }
.pont-card.manoeuvre { border-left-color: #1c3cff; animation: pulse-blue 1.2s infinite; }
.pont-card.ouvert { border-left-color: #58ff58; }
.pastille { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; display: inline-block; }
.ferme .pastille      { background: #ff4040; }
.fermeture .pastille  { background: orange; }
.manoeuvre .pastille  { background: #1c3cff; }
.ouvert .pastille     { background: #58ff58; }
.pont-nom { font-weight: bold; display: flex; align-items: center; }

/* ===================== CALENDRIER ===================== */
.right { flex:1; display:flex; flex-direction:column; height:100%; overflow:hidden; }
#calendar-header {
  flex:0 0 auto;
  padding:12px;
  text-align:center;
  font-size:22px;
  color:#00e5ff;
  border-bottom:1px solid #333;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:18px;
}
.nav-btn { cursor:pointer; color:#00e5ff; font-size:26px; padding:4px 10px; border-radius:6px; transition:0.2s; }
.nav-btn:hover { background:#222; }
.view-btn { cursor:pointer; font-size:14px; padding:4px 10px; background:#222; border-radius:6px; border:1px solid #333; color:#00e5ff; }
.view-btn:hover { background:#333; }

#calendar-grid {
  flex:1 1 auto;
  display:grid;
  gap:1px;
  background:#333;
  overflow:auto;
  box-sizing:border-box;
  padding:6px;
  position:relative;
}

.calendar-cell {
  background:#1a1a1a;
  padding:6px;
  border:1px solid #222;
  overflow:visible;
  position:relative;
  min-height:70px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
}
.date-label { font-size:12px; font-weight:normal; margin-bottom:4px; color:#ffffff; }

.cell-events { display:flex; flex-direction:column; gap:4px; z-index:4; }

.event { padding:3px 6px; border-radius:4px; font-size:12px; }
.event.reception { background:#109c5344; border-left:3px solid #109c53; color:#eaffea; }
.event.navire    { background:#3644b344; border-left:3px solid #3644b3; color:#eef0ff; }
.event-time { font-size:12px;font-weight:normal; margin-right:4px; }

.multi-band {
  position:absolute;
  height:18px;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 8px;
  box-sizing:border-box;
  font-size:12px;
  color:#fff;
  overflow:hidden;
  z-index:2;
  pointer-events:auto;
  white-space:nowrap;
}
.multi-band.reception { background: #109c53; }
.multi-band.navire    { background: #3644b3; }
.multi-band .band-left { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight:600; }
.multi-band .band-right { white-space:nowrap; margin-left:8px; }

/* ===================== MEDIA ===================== */
@media (max-width:900px){
  .left { flex:0 0 30%; }
  .calendar-cell { min-height:90px; }
}

/* ===================== HIGHLIGHT TODAY ===================== */
@keyframes pulse-today {
  0%   { box-shadow: 0 0 0 0 rgba(0,255,0,0.7); }
  50%  { box-shadow: 0 0 15px 8px rgba(0,255,0,0.7); }
  100% { box-shadow: 0 0 0 0 rgba(0,255,0,0.7); }
}

.calendar-cell.today {
  border: 2px solid #00ff00;
  background-color: #223322;
  animation: pulse-today 1.5s infinite;
  z-index:5;
}
</style>
</head>
<body>

<div class="left">
  <h2>État des Ponts</h2>
  <div id="ponts-table">Chargement…</div>
</div>

<div class="right">
  <div id="calendar-header">
    <span class="nav-btn" id="prev-btn">‹</span>
    <span id="calendar-title">Chargement…</span>
    <span class="nav-btn" id="next-btn">›</span>
    <span class="view-btn" id="view-3w">3 semaines</span>
    <span class="view-btn" id="view-4w">4 semaines</span>
    <span class="nav-btn" id="today-btn" style="font-size:18px;">Aujourd’hui</span>
  </div>
  <div id="calendar-grid"></div>
</div>

<script>
/* ===================== CONFIG ===================== */
const API_KEY = "AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo";
const CAL_RECEPTION = "receptionroulier@gmail.com";
const CAL_NAVIRE = "smr.programme@gmail.com";

let viewDays = 21; 
let offsetWeeks = 0;

const CAL_HASH_KEY = "calendarHash";
const CAL_CACHE_KEY = "calendarCache";
const CAL_REFRESH_INTERVAL = 60000; 

/* ===================== UTILITAIRES ===================== */
function getStartMonday(date){ const d=new Date(date); const day=d.getDay(); const diff=(day===0?-6:1)-day; d.setDate(d.getDate()+diff); return d; }
function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function formatDate(d){ return d.getFullYear().toString().padStart(4,'0') + '-' + (d.getMonth()+1).toString().padStart(2,'0') + '-' + d.getDate().toString().padStart(2,'0'); }
function dayName(d){ return ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()]; }
function formatMonthRange(start,end){ const m=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"]; const m1=m[start.getMonth()], m2=m[end.getMonth()]; const y1=start.getFullYear(), y2=end.getFullYear(); return (m1===m2 && y1===y2)?`${m1} ${y1}`:`${m1} — ${m2} ${y2}`; }

/* ===================== HIGHLIGHT TODAY ===================== */
function highlightToday() {
  const todayYMD = formatDate(new Date());
  document.querySelectorAll('.calendar-cell.today').forEach(c => c.classList.remove('today'));
  const todayCell = document.querySelector(`.calendar-cell[data-date="${todayYMD}"]`);
  if(todayCell) todayCell.classList.add('today');
}

/* ===================== GRID ===================== */
function createGrid(start, viewDays){
  const grid = document.getElementById('calendar-grid');
  const rows = (viewDays===21)?3:4;
  grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  grid.style.gridTemplateColumns = `repeat(7, 1fr)`;
  grid.innerHTML = '';
  const dates = [];
  for(let i=0;i<viewDays;i++){
    const d=addDays(start,i);
    const cell=document.createElement('div');
    cell.className='calendar-cell';
    cell.dataset.date=formatDate(d);
    cell.dataset.index=i;
    cell.innerHTML=`<div class="date-label">${dayName(d)} ${d.getDate()}</div><div class="cell-events"></div>`;
    grid.appendChild(cell);
    dates.push(formatDate(d));
  }
  highlightToday();
  return dates;
}

/* ===================== CLEAR ===================== */
function clearPrevious(){ const grid=document.getElementById('calendar-grid'); grid.querySelectorAll('.multi-band').forEach(n=>n.remove()); document.querySelectorAll('.calendar-cell .event').forEach(n=>n.remove()); }

/* ===================== FETCH CALENDAR ===================== */
async function hashObject(obj){ const txt=JSON.stringify(obj); const data=new TextEncoder().encode(txt); const digest=await crypto.subtle.digest("SHA-256",data); return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join(""); }
async function fetchCalendarWithHash(start, end){
  const timeMin = start.toISOString();
  const timeMax = addDays(end,1).toISOString();
  const urlRec = `https://www.googleapis.com/calendar/v3/calendars/${CAL_RECEPTION}/events?key=${API_KEY}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&singleEvents=true&orderBy=startTime`;
  const urlNav = `https://www.googleapis.com/calendar/v3/calendars/${CAL_NAVIRE}/events?key=${API_KEY}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&singleEvents=true&orderBy=startTime`;
  const [recRaw, navRaw]=await Promise.all([fetch(urlRec).then(r=>r.json()).catch(()=>({items:[]})), fetch(urlNav).then(r=>r.json()).catch(()=>({items:[]}))]);
  const events={reception: recRaw.items||[], navire: navRaw.items||[]};
  const newHash = await hashObject(events);
  const oldHash = localStorage.getItem(CAL_HASH_KEY);
  if(newHash===oldHash && localStorage.getItem(CAL_CACHE_KEY)){
    try{return JSON.parse(localStorage.getItem(CAL_CACHE_KEY));}catch{}
  }
  localStorage.setItem(CAL_HASH_KEY,newHash);
  localStorage.setItem(CAL_CACHE_KEY,JSON.stringify(events));
  return events;
}

/* ===================== NORMALISATION ===================== */
function localYMDFromDateTime(dtStr){ const d=new Date(dtStr); return formatDate(d); }
function getLocalStartYMD(ev){ if(ev.start?.date) return ev.start.date; if(ev.start?.dateTime) return localYMDFromDateTime(ev.start.dateTime); return null; }
function getLocalEndYMD_Inclusive(ev){ if(ev.end?.date){ const d=new Date(ev.end.date); d.setDate(d.getDate()-1); return formatDate(d); } if(ev.end?.dateTime){ const d=new Date(ev.end.dateTime); if(d.getHours()===0 && d.getMinutes()===0 && d.getSeconds()===0 && d.getMilliseconds()===0){ const prev=new Date(d.getTime()-1); return formatDate(prev);} return localYMDFromDateTime(ev.end.dateTime);} return null; }

/* ===================== LOAD CALENDAR ===================== */
async function loadCalendar(){
  const today = new Date();
  const mondayCurrent = getStartMonday(today);
  const start = new Date(mondayCurrent); start.setDate(start.getDate() - 7 + offsetWeeks*7);
  const end = addDays(start, viewDays - 1);
  document.getElementById('calendar-title').textContent = formatMonthRange(start, end);
  createGrid(start, viewDays);
  clearPrevious();
  try{
    const events = await fetchCalendarWithHash(start, end);
    renderBandsAndEvents(events, start, viewDays);
  }catch(err){ console.error('Erreur loadCalendar:', err); }
}

/* ===================== NAVIGATION ===================== */
document.getElementById("prev-btn").onclick = ()=>{ offsetWeeks-=1; loadCalendar(); };
document.getElementById("next-btn").onclick = ()=>{ offsetWeeks+=1; loadCalendar(); };
document.getElementById("today-btn").onclick = ()=>{ offsetWeeks=0; loadCalendar(); };
document.getElementById("view-3w").onclick = ()=>{ viewDays=21; offsetWeeks=0; loadCalendar(); };
document.getElementById("view-4w").onclick = ()=>{ viewDays=28; offsetWeeks=0; loadCalendar(); };

loadCalendar();
setInterval(loadCalendar, CAL_REFRESH_INTERVAL);

/* ===================== LE RESTE (Ponts HAROPA etc.) ===================== */
// Ton code original pour les ponts peut rester inchangé ici...
</script>
</body>
</html>
