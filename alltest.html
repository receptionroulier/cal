<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ponts HAROPA – Monitoring + Calendrier</title>

<style>
:root{
  --bg:#101010; 
  --panel:#1a1a1a; 
  --muted:#aaa; 
  --accent:#00e5ff;
}
html,body{
  height:100%;
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:#eaeaea
}
.app{
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* LEFT : PONTS */
.left{
  flex:0 0 20%;
  border-right:1px solid #444;
  padding:14px;
  background:#0e0e0e;
  box-sizing:border-box;
  overflow-y:auto;
}
.left h2{
  color:var(--accent);
  text-align:center;
  margin:0 0 12px
}

/* pont cards */
.pont-card{
  background:#1f1f1f;
  border-radius:8px;
  padding:10px 12px;
  margin-bottom:10px;
  border-left:4px solid #444;
  box-shadow:0 0 5px rgba(0,0,0,0.4);
  transition:transform .12s ease;
}
.pont-card:hover{ transform:scale(1.01) }

.pont-card.ferme{      border-left-color:#ff4040 }
.pont-card.fermeture{  border-left-color:orange;    animation:pulse-orange 1.2s infinite }
.pont-card.manoeuvre{  border-left-color:#1c3cff;   animation:pulse-blue 1.2s infinite }
.pont-card.ouvert{     border-left-color:#58ff58 }

.pastille{
  width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px
}
.ferme .pastille{background:#ff4040}
.fermeture .pastille{background:orange}
.manoeuvre .pastille{background:#1c3cff}
.ouvert .pastille{background:#58ff58}

.pont-nom{display:flex;align-items:center;font-weight:700}
.pont-etat{color:var(--muted);font-size:0.95em;margin-top:6px}
.pont-infos{color:#bbb;font-size:0.85em;margin-top:6px}

/* RIGHT : CALENDRIER */
.right{
  flex:1;
  display:flex;
  flex-direction:column;
  height:100%;
  overflow:hidden;
}

#calendar-header{
  flex:0 0 auto;
  padding:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  border-bottom:1px solid #333;
  color:var(--accent);
  font-size:20px;
}

.nav-btn{
  cursor:pointer;
  color:#ccc;
  font-size:22px;
  padding:6px 10px;
  border-radius:6px;
}
.nav-btn:hover{ background:#222 }

.view-btn{
  cursor:pointer;
  background:#222;
  border:1px solid #333;
  color:#ccc;
  padding:4px 8px;
  border-radius:6px;
}

#calendar-grid{
  flex:1 1 auto;
  display:grid;
  gap:1px;
  background:#333;
  padding:6px;
  overflow:hidden;
  box-sizing:border-box;
}

/* cellule calendrier */
.calendar-cell{
  background:var(--panel);
  padding:8px;
  border:1px solid #202020;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.date-label{
  color:var(--accent);
  font-weight:700;
  margin-bottom:6px;
  font-size:13px;
}

/* événements */
.event{
  padding:4px 6px;
  border-radius:4px;
  font-size:13px;
  margin-bottom:6px;
  overflow:hidden
}
.event.reception{
  background:rgba(16,156,83,0.18);
  border-left:3px solid #109c53;
}
.event.navire{
  background:rgba(54,68,179,0.14);
  border-left:3px solid #3644b3;
}

/* heure modifiée : petite et pas en gras */
.event-time{
  font-weight:normal;
  font-size:11px;
  margin-right:6px;
  color:#ddd;
}

/* animations */
@keyframes pulse-blue{
  0%,100%{box-shadow:0 0 5px rgba(28,60,255,0.3)}
  50%{box-shadow:0 0 18px rgba(28,60,255,0.6)}
}
@keyframes pulse-orange{
  0%,100%{box-shadow:0 0 5px rgba(255,165,0,0.3)}
  50%{box-shadow:0 0 18px rgba(255,165,0,0.6)}
}

@media (max-width:900px){ .left{flex-basis:26%} }
@media (max-width:700px){ .left{display:none} }
</style>
</head>
<body>

<div class="app">

  <div class="left">
    <h2>État des Ponts</h2>
    <div id="ponts-table">Chargement…</div>
  </div>

  <div class="right">

    <div id="calendar-header">
      <span class="nav-btn" id="prev-btn">‹</span>
      <span id="calendar-title">Chargement…</span>
      <span class="nav-btn" id="next-btn">›</span>
      <button class="view-btn" id="view-3w">3 semaines</button>
      <button class="view-btn" id="view-4w">4 semaines</button>
      <span class="nav-btn" id="today-btn" style="font-size:14px;padding:6px 8px">Aujourd’hui</span>
    </div>

    <div id="calendar-grid"></div>

  </div>
</div>


<script>
/* CONFIGURATION */
const CAL_POLL_INTERVAL_MS = 30000;
const API_KEY = "AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo";
const CAL_RECEPTION = "receptionroulier@gmail.com";
const CAL_NAVIRE = "smr.programme@gmail.com";

/* PONTS */
const CACHE_KEY_DATA="pontsData",
      CACHE_KEY_HASH="pontsHash",
      CACHE_KEY_TIME="pontsCacheTime",
      CACHE_EXPIRATION=120000,
      REFRESH_INTERVAL=60000;

const PROXIES=[
  "https://api.allorigins.win/get?url=",
  "https://cors-anywhere.herokuapp.com/",
  "https://thingproxy.freeboard.io/fetch/"
];
const PROXY_TIMEOUT_MS = 3000;

/* DATES */
function getStartMonday(date){
  const d = new Date(date);
  const day = d.getDay();
  const diff = (day===0?-6:1)-day;
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d;
}
function addDays(d,n){
  const x=new Date(d);
  x.setDate(x.getDate()+n);
  x.setHours(0,0,0,0);
  return x;
}
function formatISODate(d){ return d.toISOString().split("T")[0]; }
function dayShortName(d){ return ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()]; }
function formatMonthRange(start,end){
  const m=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  const m1=m[start.getMonth()], m2=m[end.getMonth()];
  const y1=start.getFullYear(), y2=end.getFullYear();
  return (m1===m2&&y1===y2)?`${m1} ${y1}`:`${m1} — ${m2} ${y2}`;
}

/* CALENDAR */
let offsetWeeks=0;
let viewDays=28;

async function fetchCalendarEvents(calId,timeMin,timeMax){
  const url=`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events?key=${API_KEY}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&singleEvents=true&orderBy=startTime`;
  try{
    const r=await fetch(url);
    if(!r.ok) return [];
    const j=await r.json();
    return j.items||[];
  }catch{
    return [];
  }
}

async function renderCalendar(){
  const today=new Date();
  const monday=getStartMonday(today);
  monday.setDate(monday.getDate()-7 + offsetWeeks*7);

  const start=new Date(monday);
  const end=addDays(start,viewDays-1);

  document.getElementById("calendar-title").textContent =
    formatMonthRange(start,end);

  const grid=document.getElementById("calendar-grid");
  grid.innerHTML="";
  grid.style.gridTemplateColumns="repeat(7,1fr)";
  grid.style.gridTemplateRows=`repeat(${viewDays===21?3:4},1fr)`;

  for(let i=0;i<viewDays;i++){
    const d=addDays(start,i);
    const cell=document.createElement("div");
    cell.className="calendar-cell";
    cell.dataset.date=formatISODate(d);
    cell.innerHTML=`<div class="date-label">${dayShortName(d)} ${d.getDate()}</div>`;
    grid.appendChild(cell);
  }

  const timeMin=start.toISOString();
  const timeMax=addDays(start,viewDays).toISOString();

  const [rec,nav]=await Promise.all([
    fetchCalendarEvents(CAL_RECEPTION,timeMin,timeMax),
    fetchCalendarEvents(CAL_NAVIRE,timeMin,timeMax)
  ]);

  function addEvents(evts,type){
    for(const ev of evts){
      // ✅ prend directement date ISO pour dateKey → plus de décalage
      const dateKey = ev.start.date || (ev.start.dateTime ? ev.start.dateTime.split('T')[0] : null);
      if(!dateKey) continue;
      const cell=document.querySelector(`.calendar-cell[data-date="${dateKey}"]`);
      if(!cell) continue;

      const div=document.createElement("div");
      div.className=`event ${type}`;
      let timeHtml="";
      if(ev.start.dateTime){
        const dt = new Date(ev.start.dateTime);
        const hh = dt.getHours().toString().padStart(2,"0");
        const mm = dt.getMinutes().toString().padStart(2,"0");
        timeHtml = `<span class="event-time">${hh}:${mm}</span>`;
      }
      div.innerHTML = `${timeHtml}${ev.summary||"(Sans titre)"}`;
      cell.appendChild(div);
    }
  }

  addEvents(rec,"reception");
  addEvents(nav,"navire");
}

let calendarInterval=null;
function startCalendarPolling(){
  renderCalendar();
  if(calendarInterval) clearInterval(calendarInterval);
  calendarInterval=setInterval(renderCalendar,CAL_POLL_INTERVAL_MS);
}
startCalendarPolling();

document.getElementById("prev-btn").onclick=()=>{ offsetWeeks-=(viewDays===21?3:4); startCalendarPolling(); };
document.getElementById("next-btn").onclick=()=>{ offsetWeeks+=(viewDays===21?3:4); startCalendarPolling(); };
document.getElementById("today-btn").onclick=()=>{ offsetWeeks=0; startCalendarPolling(); };
document.getElementById("view-3w").onclick=()=>{ viewDays=21; offsetWeeks=0; startCalendarPolling(); };
document.getElementById("view-4w").onclick=()=>{ viewDays=28; offsetWeeks=0; startCalendarPolling(); };

/* PONTS HAROPA - inchangé */
async function sha256hex(str){
  const data=new TextEncoder().encode(str);
  const hash=await crypto.subtle.digest("SHA-256",data);
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function fetchWithProxies(url){
  const list=[...PROXIES].sort(()=>Math.random()-0.5);
  for(const proxy of list){
    try{
      const controller=new AbortController();
      const timer=setTimeout(()=>controller.abort(),PROXY_TIMEOUT_MS);
      const r=await fetch(proxy+encodeURIComponent(url),{signal:controller.signal});
      clearTimeout(timer);
      if(!r.ok) continue;
      const d=await r.json();
      return d.contents?d.contents:d;
    }catch{}
  }
  throw new Error("All proxies failed");
}

async function updatePonts(){
  try{
    const now=Date.now();
    const last=localStorage.getItem(CACHE_KEY_TIME);

    if(last && now-last < CACHE_EXPIRATION){
      const cached=localStorage.getItem(CACHE_KEY_DATA);
      if(cached){ renderPonts(JSON.parse(cached)); return; }
    }

    const raw=await fetchWithProxies("https://www.havre-port.com/map/getPonts");
    const hash=await sha256hex(raw);
    const prev=localStorage.getItem(CACHE_KEY_HASH);

    if(hash===prev){
      const cached=localStorage.getItem(CACHE_KEY_DATA);
      if(cached){
        renderPonts(JSON.parse(cached));
        localStorage.setItem(CACHE_KEY_TIME,Date.now());
        return;
      }
    }

    const j=JSON.parse(raw);
    const ponts = Object.values(j.data||{});
    const unique = Array.from(new Map(ponts.map(p=>[p.nom,p])).values());

    const ordered = unique.sort((a,b)=>{
      const s=x=>{
        const t=(x.statutText||"").toLowerCase();
        if(t.includes("fermé")) return 1;
        if(t.includes("fermeture")) return 2;
        if(t.includes("manoeuvre")||t.includes("manœuvre")) return 3;
        if(t.includes("ouvert")) return 4;
        return 5;
      };
      return s(a)-s(b);
    });

    localStorage.setItem(CACHE_KEY_DATA,JSON.stringify(ordered));
    localStorage.setItem(CACHE_KEY_HASH,hash);
    localStorage.setItem(CACHE_KEY_TIME,Date.now());

    renderPonts(ordered);

  }catch(err){
    document.getElementById("ponts-table").textContent="Impossible de récupérer les ponts.";
  }
}

function renderPonts(arr){
  const box=document.getElementById("ponts-table");
  box.innerHTML = arr.map(p=>{
    const st=(p.statutText||"").toLowerCase();
    const cls =
      st.includes("fermé")     ? "ferme" :
      st.includes("fermeture") ? "fermeture" :
      st.includes("manoeuvre") || st.includes("manœuvre") ? "manoeuvre" :
      st.includes("ouvert")    ? "ouvert" :
      "ferme";

    const info=p.forceText||(`MàJ : ${p.date||""}`);

    return `
      <div class="pont-card ${cls}">
        <div class="pont-nom"><span class="pastille"></span>${p.nom}</div>
        <div class="pont-etat">${p.statutText||""}</div>
        <div class="pont-infos">${info}</div>
      </div>`;
  }).join("");
}

updatePonts();
setInterval(updatePonts,REFRESH_INTERVAL);

</script>
</body>
</html>
