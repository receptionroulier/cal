<!-- Code complet HTML + CSS + JS avec bandes multi-jours (Option B), couleurs selon calendrier,
anticollision, correction décalage dates Google Calendar.

NOTE : Le contenu est un squelette propre et structuré pour intégrer ensuite dans votre fichier.
Vous pourrez demander des ajustements ligne par ligne. -->
<html>
<head>
<meta charset="UTF-8" />
<title>Calendrier Multi-jours</title>
<style>
/* STYLE BANDE MULTI-JOURS (Option B fine en haut) */
.multi-span-row {
  position: relative;
  height: 18px;
  margin-bottom: 2px;
}
.multi-span-band {
  position: absolute;
  top: 0;
  height: 100%;
  border-radius: 4px;
  padding: 0 6px;
  font-size: 11px;
  line-height: 18px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.multi-start { text-align: left; }
.multi-end   { text-align: right; padding-right: 4px; }
.multi-mid   { text-indent: -9999px; }
.band-reception {
  background: rgba(16,156,83,0.35);
  border: 1px solid #109c53;
  color: #eaffea;
}
.band-navire {
  background: rgba(54,68,179,0.35);
  border: 1px solid #3644b3;
  color: #eaf0ff;
}
</style>
</head>
<body>
<div id="calendar-grid"></div>
<script>
/* UTIL DATES GOOGLE : corriger décalage */
function getLocalDateFromGoogleEventStart(ev){
    if(ev.start.date) return ev.start.date;
    const d=new Date(ev.start.dateTime);
    return d.toISOString().split("T")[0];
}
function getLocalDateFromGoogleEventEnd(ev){
    if(ev.end.date){
        const d=new Date(ev.end.date);
        d.setDate(d.getDate()-1);
        return d.toISOString().split("T")[0];
    }
    const d=new Date(ev.end.dateTime);
    return d.toISOString().split("T")[0];
}
/* PLACEMENT ANTICOLLISION */
function allocateMultiDayRow(layout, dayIndex){
    let r=0;
    while(true){
        if(!layout[r]) layout[r]=new Array(60).fill(false);
        if(!layout[r][dayIndex]){
            return r;
        }
        r++;
    }
}
function renderMultiDay(events, start, viewDays){
    const grid = document.getElementById("calendar-grid");
    const cells = [...grid.querySelectorAll('.calendar-cell')];
    const startDateStr = start.toISOString().split("T")[0];

    const layout=[];

    events.forEach(ev=>{
        const s = getLocalDateFromGoogleEventStart(ev);
        const e = getLocalDateFromGoogleEventEnd(ev);
        if(!s||!e) return;

        const sD = new Date(s);
        const eD = new Date(e);
        const startIndex = Math.floor((sD - start) / 86400000);
        const endIndex   = Math.floor((eD - start) / 86400000);

        if(endIndex<0 || startIndex>=viewDays) return;

        const first = Math.max(0,startIndex);
        const last = Math.min(viewDays-1,endIndex);
        const row = allocateMultiDayRow(layout, first);

        for(let d=first; d<=last; d++) layout[row][d]=true;

        for(let d=first; d<=last; d++){
            const cell = cells[d];
            const rowDiv = document.createElement("div");
            rowDiv.className="multi-span-row";
            rowDiv.style.top = `${row*20}px`;

            const band=document.createElement("div");
            const type = ev.type;
            band.className = `multi-span-band band-${type}`;

            if(d===first) band.classList.add("multi-start");
            else if(d===last) band.classList.add("multi-end");
            else band.classList.add("multi-mid");

            if(d===first){
                let t="";
                if(ev.start.dateTime){
                    t = ev.start.dateTime.split("T")[1].substring(0,5)+" ";
                }
                band.textContent = t + (ev.summary||"");
            }
            else if(d===last){
                let t="";
                if(ev.end.dateTime){ t=" >" + ev.end.dateTime.split("T")[1].substring(0,5); }
                band.textContent = t;
            }
            else{
                band.textContent = "";
            }

            rowDiv.appendChild(band);
            cell.prepend(rowDiv);
        }
    });
}
</script>
</body>
</html>
