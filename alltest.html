<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Calendrier Multi-jours</title>
<style>
/* === BASE CALENDAR STRUCTURE === */
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}
.calendar-cell {
  position: relative;
  border: 1px solid #ccc;
  min-height: 90px;
  padding: 4px;
  font-size: 12px;
}
.event {
  margin-top: 2px;
  padding: 2px 4px;
  border-radius: 4px;
  font-size: 12px;
}
.event.single.reception { background: #109c53; color:#fff; }
.event.single.navire { background: #3644b3; color:#fff; }

/* === MULTI-DAY EVENTS WITH LEVEL STACKING === */
.event.multi {
  position: absolute;
  left: 0;
  width: 100%;
  height: 16px;
  padding: 0 6px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
  font-size: 11px;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.multi.start { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
.multi.end { border-top-right-radius: 6px; border-bottom-right-radius: 6px; }

.multi.reception {
  background: rgba(16,156,83,0.85);
  border-left: 4px solid #109c53;
}
.multi.navire {
  background: rgba(54,68,179,0.85);
  border-left: 4px solid #3644b3;
}
.event-endtime {
  margin-left: auto;
  opacity: 0.9;
  font-size: 10px;
}
</style>
</head>
<body>

<div id="calendar" class="calendar"></div>

<script>
/* ===========================
   GENERIC UTILITIES
=========================== */
function addDays(date, d){ const r=new Date(date); r.setDate(r.getDate()+d); return r; }
function formatDate(d){ return d.toISOString().split("T")[0]; }

/* ===========================
   BUILD CALENDAR
=========================== */
let viewDays = 35;
let startDate = new Date(); startDate.setDate(1);

function buildCalendar(){
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  for(let i=0;i<viewDays;i++){
    const d = addDays(startDate,i);
    const cell = document.createElement("div");
    cell.className = "calendar-cell";
    cell.dataset.date = formatDate(d);
    cell.innerHTML = `<strong>${d.getDate()}</strong>`;
    cal.appendChild(cell);
  }
}
buildCalendar();

/* ===========================
   MULTI-DAY LEVEL CALC ENGINE
=========================== */
function computeMultiDayLevels(multiEvents, startDate, viewDays) {
  const daySlots = Array.from({length: viewDays}, () => []);
  const eventPositions = new Map();

  multiEvents.forEach(ev => {
    const startStr = ev.start.date || ev.start.dateTime.split("T")[0];
    const endStr   = ev.end.date   || ev.end.dateTime.split("T")[0];

    let s = new Date(startStr);
    let e = new Date(endStr);
    e.setDate(e.getDate()-1);

    let startIndex = Math.floor((s - startDate) / 86400000);
    let endIndex   = Math.floor((e - startDate) / 86400000);
    if(startIndex < 0) startIndex = 0;
    if(endIndex >= viewDays) endIndex = viewDays-1;

    let level = 0;
    while(true){
      let conflict = false;
      for(let i=startIndex;i<=endIndex;i++){
        if(daySlots[i][level]){ conflict=true; break; }
      }
      if(!conflict) break;
      level++;
    }
    for(let i=startIndex;i<=endIndex;i++) daySlots[i][level]=ev;
    eventPositions.set(ev,{ startIndex, endIndex, level });
  });
  return eventPositions;
}

/* ===========================
   RENDER EVENTS
=========================== */
function insertSingleDayEvent(dateStr, ev, type){
  const cell=document.querySelector(`[data-date="${dateStr}"]`);
  if(!cell) return;
  const d=document.createElement("div");
  d.className=`event single ${type}`;
  let time="";
  if(ev.start.dateTime){ time = ev.start.dateTime.split("T")[1].substring(0,5) + " - "; }
  d.textContent = time + (ev.summary || "(Sans titre)");
  cell.appendChild(d);
}

function renderEvents(events, type){
  const firstCell = document.querySelector(".calendar-cell");
  const startDate = new Date(firstCell.dataset.date);

  const single=[], multi=[];
  events.forEach(ev=>{
    const s = ev.start.date || ev.start.dateTime?.split("T")[0];
    const e = ev.end.date   || ev.end.dateTime?.split("T")[0];
    if(!e || s===e) single.push(ev);
    else multi.push(ev);
  });

  single.forEach(ev=>{
    const ds = ev.start.date || ev.start.dateTime.split("T")[0];
    insertSingleDayEvent(ds,ev,type);
  });

  const levels = computeMultiDayLevels(multi,startDate,viewDays);
  const baseTop=26, rowHeight=18;

  multi.forEach(ev=>{
    const pos = levels.get(ev);
    const { startIndex, endIndex, level } = pos;

    for(let i=startIndex;i<=endIndex;i++){
      const dateStr = formatDate(addDays(startDate,i));
      const cell = document.querySelector(`[data-date="${dateStr}"]`);
      if(!cell) continue;
      const bar=document.createElement("div");
      bar.className=`event multi ${type}`;
      bar.style.top = (baseTop + level*rowHeight) + "px";
      if(i===startIndex) bar.classList.add("start");
      if(i===endIndex) bar.classList.add("end");

      if(i===startIndex) bar.textContent = ev.summary || "(Sans titre)";
      if(i===endIndex && ev.end.dateTime){
        const et = ev.end.dateTime.split("T")[1].substring(0,5);
        bar.innerHTML += `<span class="event-endtime">→ ${et}</span>`;
      }

      cell.appendChild(bar);
    }
  });
}

/* ===========================
   DEMO EVENTS (you can replace)
=========================== */
const eventsReception = [
  { summary:"Salon Pro", start:{date:"2025-11-03"}, end:{date:"2025-11-06"} },
  { summary:"Congrès Médical", start:{date:"2025-11-04"}, end:{date:"2025-11-10"} }
];
const eventsNavire = [
  { summary:"Navire A", start:{dateTime:"2025-11-05T08:00"}, end:{dateTime:"2025-11-05T14:00"} },
  { summary:"Navire B", start:{date:"2025-11-06"}, end:{date:"2025-11-09"} }
];

renderEvents(eventsReception, "reception");
renderEvents(eventsNavire, "navire");
</script>
</body>
</html>
