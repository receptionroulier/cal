<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ponts HAROPA – Monitoring + Calendrier</title>

<style>
/* =====================
   GLOBAL
===================== */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #101010;
    color: #eaeaea;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.left {
    flex: 0 0 20%;
    border-right: 1px solid #444;
    padding: 14px;
    overflow-y: auto;
    box-sizing: border-box;
}

.right {
    flex: 1;
    padding: 0;
    overflow-y: auto;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
}

/* =====================
   CALENDRIER
===================== */

#calendar-header {
    padding: 12px;
    text-align: center;
    font-size: 22px;
    color: #00e5ff;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 18px;
}

.nav-btn {
    cursor: pointer;
    color: #ccc;
    font-size: 26px;
    padding: 4px 10px;
    border-radius: 6px;
    transition: 0.2s;
}

.nav-btn:hover {
    background: #222;
}

.view-btn {
    cursor: pointer;
    font-size: 14px;
    padding: 4px 10px;
    background: #222;
    border-radius: 6px;
    border: 1px solid #333;
    color: #ccc;
}

.view-btn:hover {
    background: #333;
}

#calendar-grid {
    flex: 1;
    display: grid;
    gap: 1px;
    background: #333;
}

.calendar-cell {
    background: #1a1a1a;
    padding: 6px;
    border: 1px solid #222;
    overflow-y: auto;
}

.date-label {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
    color: #00e5ff;
}

.event {
    padding: 3px 5px;
    border-radius: 4px;
    font-size: 13px;
    margin-bottom: 4px;
}

.event.reception { background: #109c5344; border-left: 3px solid #109c53; }
.event.navire { background: #3644b344; border-left: 3px solid #3644b3; }

.event-time {
    font-weight: bold;
    margin-right: 4px;
}
</style>
</head>

<body>

<!-- =====================
     COLONNE GAUCHE (PONTS)
===================== -->

<div class="left">
    <h2>État des Ponts</h2>
    <div id="ponts-table">Chargement…</div>
</div>

<!-- =====================
     COLONNE DROITE (CALENDRIER)
===================== -->

<div class="right">

    <div id="calendar-header">
        <span class="nav-btn" id="prev-btn">‹</span>
        <span id="calendar-title">Chargement…</span>
        <span class="nav-btn" id="next-btn">›</span>

        <span class="view-btn" id="view-3w">3 semaines</span>
        <span class="view-btn" id="view-4w">4 semaines</span>

        <span class="nav-btn" id="today-btn" style="font-size:18px;">Aujourd’hui</span>
    </div>

    <div id="calendar-grid"></div>
</div>

<script>
// -----------------------------
// CONFIGURATION GOOGLE CALENDAR
// -----------------------------
const API_KEY = "AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo";

const CAL_RECEPTION = "receptionroulier@gmail.com";
const CAL_NAVIRE = "smr.programme@gmail.com";

let offsetWeeks = 0;
let viewDays = 28; // 28 par défaut (4 semaines)

// -----------------------------
// FONCTIONS CALENDRIER
// -----------------------------

function getStartMonday(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    d.setDate(d.getDate() + diff);
    return d;
}

function addDays(date, n) {
    const d = new Date(date);
    d.setDate(d.getDate() + n);
    return d;
}

function formatDate(d) {
    return d.toISOString().split("T")[0];
}

function formatMonthRange(start, end) {
    const months = [
        "Janvier","Février","Mars","Avril","Mai","Juin",
        "Juillet","Août","Septembre","Octobre","Novembre","Décembre"
    ];

    const m1 = months[start.getMonth()];
    const m2 = months[end.getMonth()];

    const y1 = start.getFullYear();
    const y2 = end.getFullYear();

    if (m1 === m2 && y1 === y2) return `${m1} ${y1}`;
    return `${m1} — ${m2} ${y2}`;
}

async function fetchEvents(calendarId, timeMin, timeMax) {
    const url =
        `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events` +
        `?key=${API_KEY}&timeMin=${encodeURIComponent(timeMin)}` +
        `&timeMax=${encodeURIComponent(timeMax)}&singleEvents=true&orderBy=startTime`;

    const res = await fetch(url);
    const data = await res.json();
    return data.items || [];
}

async function loadCalendar() {

    const today = new Date();
    const monday = getStartMonday(today);

    monday.setDate(monday.getDate() - 7 + offsetWeeks * 7);

    const start = new Date(monday);
    const end = addDays(start, viewDays - 1);

    document.getElementById("calendar-title").textContent =
        formatMonthRange(start, end);

    const grid = document.getElementById("calendar-grid");

    const rows = viewDays === 21 ? 3 : 4;
    grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    grid.style.gridTemplateColumns = `repeat(7, 1fr)`;

    grid.innerHTML = "";

    for (let i = 0; i < viewDays; i++) {
        const cell = document.createElement("div");
        cell.className = "calendar-cell";
        const d = addDays(start, i);

        cell.innerHTML = `<div class="date-label">${d.getDate()}</div>`;
        cell.dataset.date = formatDate(d);

        grid.appendChild(cell);
    }

    const timeMin = start.toISOString();
    const timeMax = addDays(start, viewDays).toISOString();

    const recEvents = await fetchEvents(CAL_RECEPTION, timeMin, timeMax);
    const navEvents = await fetchEvents(CAL_NAVIRE, timeMin, timeMax);

    renderEvents(recEvents, "reception");
    renderEvents(navEvents, "navire");
}

function renderEvents(events, type) {
    events.forEach(ev => {
        const date = ev.start.date || ev.start.dateTime?.split("T")[0];
        const cell = document.querySelector(`[data-date="${date}"]`);
        if (!cell) return;

        const div = document.createElement("div");
        div.className = `event ${type}`;

        let timeStr = "";
        if (ev.start.dateTime) {
            const t = ev.start.dateTime.split("T")[1].substring(0,5);
            timeStr = `<span class="event-time">${t}</span>`;
        }

        div.innerHTML = `${timeStr}${ev.summary || "(Sans titre)"}`;
        cell.appendChild(div);
    });
}

// -----------------------------
// NAVIGATION
// -----------------------------
document.getElementById("prev-btn").onclick = () => {
    offsetWeeks -= 1;
    loadCalendar();
};

document.getElementById("next-btn").onclick = () => {
    offsetWeeks += 1;
    loadCalendar();
};

document.getElementById("today-btn").onclick = () => {
    offsetWeeks = 0;
    loadCalendar();
};

// -----------------------------
// CHANGEMENT DE VUE
// -----------------------------
document.getElementById("view-3w").onclick = () => {
    viewDays = 21;
    loadCalendar();
};

document.getElementById("view-4w").onclick = () => {
    viewDays = 28;
    loadCalendar();
};

// -----------------------------
// INIT
// -----------------------------
loadCalendar();
</script>

</body>
</html>
