<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ponts HAROPA – Monitoring + Calendrier</title>
<style>
body {
    margin:0;
    font-family: Arial,sans-serif;
    background:#101010;
    color:#eaeaea;
    display:flex;
    height:100vh;
}
.left{flex:0 0 20%;border-right:1px solid #444;padding:14px;overflow-y:auto;box-sizing:border-box;}
.right{flex:1;padding:10px;overflow:auto;}
h2{text-align:center;color:#00e5ff;margin:0 0 15px;}

/* ===== PONTS ===== */
#ponts-table{display:flex;flex-direction:column;gap:10px;}
.pont-card{background:#1f1f1f;border-radius:8px;padding:10px 12px;box-shadow:0 0 5px rgba(0,0,0,0.4);border-left:4px solid #444;transition: transform 0.15s ease, box-shadow 0.3s ease;}
.pont-card:hover{transform:scale(1.02);}
.pont-card.ferme{border-left-color:#ff4040;}
.pont-card.fermeture{border-left-color:orange;animation:pulse-orange 1.2s infinite;}
.pont-card.manoeuvre{border-left-color:#1c3cff;animation:pulse-blue 1.2s infinite;}
.pont-card.ouvert{border-left-color:#58ff58;}
.pastille{width:10px;height:10px;border-radius:50%;margin-right:6px;display:inline-block;}
.ferme .pastille{background:#ff4040;}
.fermeture .pastille{background:orange;}
.manoeuvre .pastille{background:#1c3cff;}
.ouvert .pastille{background:#58ff58;}
.pont-nom{font-weight:bold;display:flex;align-items:center;}
@keyframes pulse-blue{0%,100%{box-shadow:0 0 5px rgba(28,60,255,0.4);transform:scale(1);}50%{box-shadow:0 0 20px rgba(28,60,255,0.7);transform:scale(1.02);}}
@keyframes pulse-orange{0%,100%{box-shadow:0 0 5px rgba(255,165,0.4);transform:scale(1);}50%{box-shadow:0 0 20px rgba(255,165,0.7);transform:scale(1.02);}}

/* ===== CALENDRIER STYLE GOOGLE AGENDA ===== */
#calendar-grid{display:grid;grid-template-columns:50px repeat(7*4,1fr);grid-auto-rows:40px;background:#1a1a1a;border-radius:6px;}
.hour-cell{border-top:1px solid #333;border-right:1px solid #333;font-size:0.75em;color:#aaa;padding:2px;text-align:right;}
.day-header{background:#222;padding:2px 4px;text-align:center;border-right:1px solid #333;font-weight:bold;}
.event-card{position:absolute;padding:2px 4px;border-radius:3px;font-size:0.75em;overflow:hidden;color:#fff;}
.event-reception{background:#109c53;}
.event-navire{background:#3644b3;}
.grid-container{position:relative;}
</style>
</head>
<body>

<div class="left">
    <div class="container">
        <h2>État des Ponts</h2>
        <div id="ponts-table">Chargement...</div>
    </div>
</div>

<div class="right">
    <h2>Calendrier 28 jours</h2>
    <div id="calendar-container" style="overflow:auto;position:relative;height:90%;"></div>
</div>

<script>
// ===== PONTS =====
const CACHE_KEY_DATA="pontsData";
const CACHE_KEY_HASH="pontsHash";
const CACHE_KEY_TIME="pontsCacheTime";
const CACHE_EXPIRATION=120000;
const REFRESH_INTERVAL=60000;
const PROXIES=["https://api.allorigins.win/get?url=","https://cors-anywhere.herokuapp.com/","https://thingproxy.freeboard.io/fetch/"];
async function sha256(str){const data=new TextEncoder().encode(str);const digest=await crypto.subtle.digest("SHA-256",data);return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");}
async function fetchWithRandomProxy(url){const shuffled=[...PROXIES].sort(()=>Math.random()-0.5);for(const proxy of shuffled){try{const fullUrl=proxy+encodeURIComponent(url);const res=await fetch(fullUrl);if(!res.ok)throw new Error(`Proxy failed: ${res.status}`);const data=await res.json();return data.contents?data.contents:data;}catch(err){console.warn(`Échec du proxy ${proxy}:`,err.message);}}throw new Error("Tous les proxys ont échoué");}
async function checkAndUpdate(){const now=Date.now();const last=localStorage.getItem(CACHE_KEY_TIME);if(last&&now-last<CACHE_EXPIRATION){const cached=localStorage.getItem(CACHE_KEY_DATA);if(cached){renderPonts(JSON.parse(cached));return;}}await fetchWithHashControl();}
async function fetchWithHashControl(){try{const rawContent=await fetchWithRandomProxy("https://www.havre-port.com/map/getPonts");const newHash=await sha256(rawContent);const oldHash=localStorage.getItem(CACHE_KEY_HASH);if(newHash===oldHash){const cached=localStorage.getItem(CACHE_KEY_DATA);if(cached){renderPonts(JSON.parse(cached));return;}}const ponts=Object.values(JSON.parse(rawContent).data);const unique=Array.from(new Map(ponts.map(p=>[p.nom,p])).values());const ordered=unique.sort((a,b)=>{const score=p=>{const statut=p.statutText.toLowerCase();if(statut.includes("fermé"))return 1;if(statut.includes("fermeture"))return 2;if(statut.includes("manoeuvre"))return 3;if(statut.includes("ouvert"))return 4;return 5;};return score(a)-score(b);});localStorage.setItem(CACHE_KEY_DATA,JSON.stringify(ordered));localStorage.setItem(CACHE_KEY_HASH,newHash);localStorage.setItem(CACHE_KEY_TIME,Date.now());renderPonts(ordered);}catch(err){console.error("Erreur récupération ponts:",err);document.getElementById("ponts-table").textContent="Impossible de récupérer les ponts.";}}

function renderPonts(list){
    const container=document.getElementById("ponts-table");
    container.innerHTML=list.map(p=>{
        const statut=p.statutText.toLowerCase();
        const open=statut.includes("ouvert");
        const move=statut.includes("manoeuvre");
        const fermeture=statut.includes("fermeture");
        const ferme=statut.includes("fermé");
        const cls=ferme?"ferme":fermeture?"fermeture":move?"manoeuvre":open?"ouvert":"ferme";
        const info=p.forceText||`MàJ : ${p.date}`;
        return `<div class="pont-card ${cls}"><div class="pont-nom"><span class="pastille"></span>${p.nom}</div><div class="pont-etat">${p.statutText}</div><div class="pont-infos">${info}</div></div>`;
    }).join("");
}
checkAndUpdate();setInterval(checkAndUpdate,REFRESH_INTERVAL);

// ===== CALENDRIER STYLE GOOGLE AGENDA =====
const API_KEY="AIzaSyDkQkqPoOGf8umYg2dbeTU0THfLlJnCjXo";
const CALENDARS=[
    {id:"receptionroulier@gmail.com",className:"event-reception"},
    {id:"smr.programme@gmail.com",className:"event-navire"}
];
const CALENDAR_CONTAINER=document.getElementById("calendar-container");

function get28DaysGrid(){
    const days=[];
    const today=new Date();
    today.setHours(0,0,0,0);
    const start=new Date(today);
    start.setDate(today.getDate()-today.getDay()+1); // lundi de la semaine actuelle
    for(let i=0;i<28;i++){
        const d=new Date(start);
        d.setDate(start.getDate()+i);
        days.push(d);
    }
    return days;
}

function formatDay(date){return date.toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"});}
function formatTime(dateStr){const date=new Date(dateStr);return date.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});}

async function fetchEventsForCalendar(calendarId){
    const now=new Date().toISOString();
    const maxTime=new Date(Date.now()+28*24*60*60*1000).toISOString();
    const url=`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?key=${API_KEY}&timeMin=${now}&timeMax=${maxTime}&singleEvents=true&orderBy=startTime`;
    try{const res=await fetch(url);const data=await res.json();return data.items||[];}catch(err){console.error(err);return [];}
}

async function renderGoogleStyleCalendar(){
    const days=get28DaysGrid();
    const grid=document.createElement("div");
    grid.id="calendar-grid";
    grid.className="grid-container";
    grid.style.position="relative";

    // Header ligne heures
    const hourColumn=document.createElement("div");
    hourColumn.className="hour-cell";
    hourColumn.style.gridRow="1 / 2";
    grid.appendChild(hourColumn);

    // Header jours
    days.forEach((day,i)=>{
        const cell=document.createElement("div");
        cell.className="day-header";
        cell.style.gridColumn=(i+2)+"/"+(i+3);
        cell.style.gridRow="1/2";
        cell.textContent=formatDay(day);
        grid.appendChild(cell);
    });

    // lignes heures
    for(let h=0;h<24;h++){
        const hourCell=document.createElement("div");
        hourCell.className="hour-cell";
        hourCell.style.gridRow=(h+2)+"/"+(h+3);
        hourCell.style.gridColumn="1/2";
        hourCell.textContent=(h+":00");
        grid.appendChild(hourCell);
    }

    CALENDAR_CONTAINER.innerHTML="";
    CALENDAR_CONTAINER.appendChild(grid);

    // fetch events
    let allEvents=[];
    for(const cal of CALENDARS){
        const events=await fetchEventsForCalendar(cal.id);
        events.forEach(ev=>{ev.calendarClass=cal.className;});
        allEvents=allEvents.concat(events);
    }

    // placer les events
    allEvents.forEach(ev=>{
        const start=new Date(ev.start.dateTime||ev.start.date);
        const end=new Date(ev.end.dateTime||ev.end.date);
        const dayIndex=days.findIndex(d=>d.toDateString()===start.toDateString());
        if(dayIndex<0) return;
        const top=(start.getHours()+start.getMinutes()/60)*40+40; // hauteur ligne 40px
        const height=((end-start)/1000/3600)*40;
        const left=dayIndex*200+50;
        const eventDiv=document.createElement("div");
        eventDiv.className=`event-card ${ev.calendarClass}`;
        eventDiv.style.top=top+"px";
        eventDiv.style.left=left+"px";
        eventDiv.style.height=height+"px";
        eventDiv.style.width="190px";
        eventDiv.textContent=ev.summary||"Sans titre";
        grid.appendChild(eventDiv);
    });
}

renderGoogleStyleCalendar();
setInterval(renderGoogleStyleCalendar,30000);
</script>

</body>
</html>
