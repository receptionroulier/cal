<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ponts HAROPA – Monitoring</title>
<style>
/* =====================
   GLOBAL
===================== */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #101010;
    color: #eaeaea;
    display: flex;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
}
.container {
    width: 25%;
    padding: 14px;
    box-sizing: border-box;
    overflow-y: auto;
}
h2 {
    text-align: center;
    color: #00e5ff;
    margin: 0 0 15px;
}

/* =====================
   CARTES PONTS
===================== */
#ponts-table {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.pont-card {
    background: #1f1f1f;
    border-radius: 8px;
    padding: 10px 12px;
    box-shadow: 0 0 5px rgba(0,0,0,0.4);
    border-left: 4px solid #444;
    transition: transform 0.15s ease, box-shadow 0.3s ease;
}
.pont-card:hover { transform: scale(1.02); }
.pont-card.ferme { border-left-color: #ff4040; }
.pont-card.fermeture { border-left-color: orange; animation: pulse-orange 1.2s infinite; }
.pont-card.manoeuvre { border-left-color: #1c3cff; animation: pulse-blue 1.2s infinite; }
.pont-card.ouvert { border-left-color: #58ff58; }
.pastille { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; display: inline-block; }
.ferme .pastille    { background: #ff4040; }
.fermeture .pastille { background: orange; }
.manoeuvre .pastille { background: #1c3cff; }
.ouvert .pastille   { background: #58ff58; }
.pont-nom { font-weight: bold; display: flex; align-items: center; }

@keyframes pulse-blue {
    0%,100% { box-shadow: 0 0 5px rgba(28,60,255,0.4); transform: scale(1); }
    50% { box-shadow: 0 0 20px rgba(28,60,255,0.7); transform: scale(1.02); }
}
@keyframes pulse-orange {
    0%,100% { box-shadow: 0 0 5px rgba(255,165,0,0.4); transform: scale(1); }
    50% { box-shadow: 0 0 20px rgba(255,165,0,0.7); transform: scale(1.02); }
}
</style>
</head>
<body>

<div class="container">
    <h2>État des Ponts</h2>
    <div id="ponts-table">Chargement...</div>
</div>

<script>
// =====================
// CONFIGURATION
// =====================
const CACHE_KEY_DATA = "pontsData";
const CACHE_KEY_HASH = "pontsHash";
const CACHE_KEY_TIME = "pontsCacheTime";
const CACHE_EXPIRATION = 120000; // cache 2 minutes
const REFRESH_INTERVAL = 60000; // refresh chaque minute

const PROXIES = [
    "https://api.allorigins.win/get?url=",
    "https://cors-anywhere.herokuapp.com/",
    "https://thingproxy.freeboard.io/fetch/"
];

// =====================
// UTILITAIRES
// =====================
async function sha256(str) {
    const data = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(digest))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

// =====================
// FETCH MULTI-PROXY ALÉATOIRE
// =====================
async function fetchWithRandomProxy(url) {
    const shuffledProxies = [...PROXIES].sort(() => Math.random() - 0.5);
    for (const proxy of shuffledProxies) {
        try {
            const fullUrl = proxy + encodeURIComponent(url);
            const res = await fetch(fullUrl);
            if (!res.ok) throw new Error(`Proxy failed: ${res.status}`);
            const data = await res.json();
            return data.contents ? data.contents : data;
        } catch (err) {
            console.warn(`Échec du proxy ${proxy}:`, err.message);
        }
    }
    throw new Error("Tous les proxys ont échoué");
}

// =====================
// LOGIQUE PONTS
// =====================
async function checkAndUpdate() {
    const now = Date.now();
    const last = localStorage.getItem(CACHE_KEY_TIME);
    if (last && now - last < CACHE_EXPIRATION) {
        const cached = localStorage.getItem(CACHE_KEY_DATA);
        if (cached) { renderPonts(JSON.parse(cached)); console.log("⚡ Cache utilisé"); return; }
    }
    await fetchWithHashControl();
}

async function fetchWithHashControl() {
    try {
        const rawContent = await fetchWithRandomProxy("https://www.havre-port.com/map/getPonts");
        const newHash = await sha256(rawContent);
        const oldHash = localStorage.getItem(CACHE_KEY_HASH);

        if (newHash === oldHash) {
            const cached = localStorage.getItem(CACHE_KEY_DATA);
            if (cached) { renderPonts(JSON.parse(cached)); return; }
        }

        const ponts = Object.values(JSON.parse(rawContent).data);
        const unique = Array.from(new Map(ponts.map(p => [p.nom, p])).values());
        const ordered = unique.sort((a, b) => {
            const score = p => {
                const statut = p.statutText.toLowerCase();
                if (statut.includes("fermé")) return 1;
                if (statut.includes("fermeture")) return 2;
                if (statut.includes("manoeuvre")) return 3;
                if (statut.includes("ouvert")) return 4;
                return 5;
            };
            return score(a) - score(b);
        });

        localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(ordered));
        localStorage.setItem(CACHE_KEY_HASH, newHash);
        localStorage.setItem(CACHE_KEY_TIME, Date.now());
        renderPonts(ordered);

    } catch (err) {
        console.error("Erreur récupération ponts:", err);
        document.getElementById("ponts-table").textContent = "Impossible de récupérer les ponts.";
    }
}

function renderPonts(list) {
    const container = document.getElementById("ponts-table");
    container.innerHTML = list.map(p => {
        const statut = p.statutText.toLowerCase();
        const open = statut.includes("ouvert");
        const move = statut.includes("manoeuvre");
        const fermeture = statut.includes("fermeture");
        const ferme = statut.includes("fermé");
        const cls = ferme ? "ferme" : fermeture ? "fermeture" : move ? "manoeuvre" : open ? "ouvert" : "ferme";
        const info = p.forceText || `MàJ : ${p.date}`;

        return `
            <div class="pont-card ${cls}">
                <div class="pont-nom">
                    <span class="pastille"></span>${p.nom}
                </div>
                <div class="pont-etat">${p.statutText}</div>
                <div class="pont-infos">${info}</div>
            </div>
        `;
    }).join("");
}

// =====================
// INITIALISATION
// =====================
checkAndUpdate();
setInterval(checkAndUpdate, REFRESH_INTERVAL);

</script>
</body>
</html>
