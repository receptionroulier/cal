<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ponts HAROPA – Monitoring</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #101010;
    color: #eaeaea;
}

.container {
    height: 100vh;
    padding: 14px;
    box-sizing: border-box;
}

h2 {
    text-align: center;
    color: #00e5ff;
    margin: 0 0 15px;
}

#ponts-table {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.pont-card {
    background: #1f1f1f;
    border-radius: 8px;
    padding: 10px 12px;
    box-shadow: 0 0 5px rgba(0,0,0,0.4);
    border-left: 4px solid #444;
    transition: transform 0.15s ease, box-shadow 0.3s ease;
}
.pont-card:hover { transform: scale(1.02); }

.pont-card.ferme { border-left-color: #ff4040; }
.pont-card.ouvert { border-left-color: #58ff58; }
.pont-card.manoeuvre { border-left-color: #1c3cff; }

.pastille { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; display: inline-block; }
.ferme .pastille { background: #ff4040; }
.ouvert .pastille { background: #58ff58; }
.manoeuvre .pastille { background: #1c3cff; }

.pont-card.manoeuvre { animation: pulse 1.2s infinite; }
@keyframes pulse {
    0% { box-shadow: 0 0 5px rgba(28, 60, 255, 0.4); transform: scale(1); }
    50% { box-shadow: 0 0 20px rgba(28, 60, 255, 0.7); transform: scale(1.02); }
    100% { box-shadow: 0 0 5px rgba(28, 60, 255, 0.4); transform: scale(1); }
}

.pont-nom { font-weight: bold; display: flex; align-items: center; }
</style>
</head>

<body>
<div class="container">
    <h2>État des Ponts</h2>
    <div id="ponts-table">Chargement...</div>
</div>

<script>
const CACHE_KEY_DATA = "pontsData";
const CACHE_KEY_HASH = "pontsHash";
const CACHE_KEY_TIME = "pontsCacheTime";
const CACHE_EXPIRATION = 120000; // 120s
const REFRESH_INTERVAL = 60000; // 60s

async function sha256(str) {
    const data = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,"0")).join("");
}

async function checkAndUpdate() {
    const now = Date.now();
    const last = localStorage.getItem(CACHE_KEY_TIME);

    if(last && now - last < CACHE_EXPIRATION) {
        const cached = localStorage.getItem(CACHE_KEY_DATA);
        if(cached) {
            renderPonts(JSON.parse(cached));
            console.log("⚡ Cache utilisé");
            return;
        }
    }

    await fetchWithFallback();
}

/* FETCH AVEC FALLBACK AUTOMATIQUE */
async function fetchWithFallback() {
    const url = "https://www.havre-port.com/map/getPonts";
    const proxies = [
        `https://api.allorigins.org/get?url=${encodeURIComponent(url)}`,
        `https://corsproxy.io/?${encodeURIComponent(url)}`
    ];

    for (let proxy of proxies) {
        try {
            const res = await fetch(proxy);
            if(!res.ok) throw new Error("Proxy indisponible");

            let rawContent;
            if(proxy.includes("allorigins")) {
                const raw = await res.json();
                rawContent = raw.contents;
            } else {
                rawContent = await res.text();
            }

            const newHash = await sha256(rawContent);
            const oldHash = localStorage.getItem(CACHE_KEY_HASH);

            if(newHash === oldHash) {
                const cached = localStorage.getItem(CACHE_KEY_DATA);
                if(cached) {
                    console.log("✔ Hash identique → cache utilisé");
                    renderPonts(JSON.parse(cached));
                    return;
                }
            }

            const ponts = Object.values(JSON.parse(rawContent).data);
            const unique = Array.from(new Map(ponts.map(p => [p.nom,p])).values());

            const ordered = unique.sort((a,b) => {
                const score = p => {
                    const statut = p.statutText.toLowerCase();
                    if(statut.includes("manoeuvre")) return 1;
                    if(statut.includes("ouvert")) return 2;
                    return 0;
                };
                return score(a)-score(b);
            });

            localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(ordered));
            localStorage.setItem(CACHE_KEY_HASH, newHash);
            localStorage.setItem(CACHE_KEY_TIME, Date.now());

            renderPonts(ordered);
            return;

        } catch(err) {
            console.warn("Proxy échoué, tentative suivante...", proxy, err);
        }
    }

    document.getElementById("ponts-table").textContent =
        "Impossible de récupérer les ponts, tous les proxies ont échoué.";
    console.error("Tous les proxies ont échoué");
}

function renderPonts(list) {
    const container = document.getElementById("ponts-table");
    container.innerHTML = list.map(p => {
        const statut = p.statutText.toLowerCase();
        const open = statut.includes("ouvert");
        const move = statut.includes("manoeuvre");
        const cls = move ? "manoeuvre" : open ? "ouvert" : "ferme";
        const info = p.forceText || `MàJ : ${p.date}`;

        return `
            <div class="pont-card ${cls}">
                <div class="pont-nom"><span class="pastille"></span>${p.nom}</div>
                <div class="pont-etat">${p.statutText}</div>
                <div class="pont-infos">${info}</div>
            </div>
        `;
    }).join("");
}

checkAndUpdate();
setInterval(checkAndUpdate, REFRESH_INTERVAL);
</script>
</body>
</html>
